<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>MalOffice Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/static/css/report.css">
</head>
<body>
  <div class="card">
    <h1>Extracted Report</h1>
    <div class="meta">
      <span class="badge">share_id: {{ share_id }}</span>
      &nbsp;â€¢&nbsp; created_at: {{ created_at }}
      {% if ttl %}&nbsp;â€¢&nbsp; TTL: {{ ttl }}s{% endif %}
    </div>
  </div>

  <div class="card">
    <h2>File</h2>
    <div class="meta">filename: <strong>{{ data.filename }}</strong> &nbsp;â€¢&nbsp;
      mime: {{ data.mime_type or "-" }} &nbsp;â€¢&nbsp; size: {{ data.size_bytes }}B
      {% if data.sha256 %}&nbsp;â€¢&nbsp; SHA256: {{ data.sha256[:16] }}...{% endif %}
    </div>
  </div>

  {% if data.analysis_report %}
  <div class="card">
    <h2>ì •ì  ë¶„ì„ ê²°ê³¼</h2>
    <div class="analysis-section">
      <h3>íŒŒì¼ êµ¬ì¡°</h3>
      {% set structure = data.analysis_report.features.structure if data.analysis_report and data.analysis_report.features else {} %}
      <div class="meta">
        Format: <strong>{{ structure.format or "unknown" }}</strong> &nbsp;â€¢&nbsp;
        OLE Header Valid: {{ "âœ“" if structure.ole_header_valid else "âœ—" }} &nbsp;â€¢&nbsp;
        Streams: {{ structure.streams_count or 0 }} &nbsp;â€¢&nbsp;
        Storages: {{ structure.storages_count or 0 }}
      </div>
      {% if structure.metadata_anomalies %}
      <div class="anomalies">
        <strong>ì´ìƒ ì§•í›„:</strong>
        {% for anomaly in structure.metadata_anomalies %}
          <span class="badge warning">{{ anomaly }}</span>
        {% endfor %}
      </div>
      {% endif %}
    </div>

    {% set macros = data.analysis_report.features.macros if data.analysis_report and data.analysis_report.features else {} %}
    {% if macros.has_vba %}
    <div class="analysis-section">
      <h3>ë§¤í¬ë¡œ ë¶„ì„</h3>
      <div class="meta">
        VBA ë§¤í¬ë¡œ: <strong class="danger">ë°œê²¬ë¨</strong> &nbsp;â€¢&nbsp;
        ëª¨ë“ˆ ìˆ˜: {{ macros.modules|length or 0 }} &nbsp;â€¢&nbsp;
        ì˜ì‹¬ìŠ¤ëŸ¬ìš´ API í˜¸ì¶œ: {{ macros.suspicious_api_calls_count or 0 }}
      </div>
      {% if macros.autoexec_triggers %}
      <div class="autoexec">
        <strong>ìë™ ì‹¤í–‰ íŠ¸ë¦¬ê±°:</strong>
        {% for trigger in macros.autoexec_triggers %}
          <span class="badge danger">{{ trigger }}</span>
        {% endfor %}
      </div>
      {% endif %}
      {% if macros.modules %}
      <div class="modules">
        <strong>VBA ëª¨ë“ˆ:</strong>
        {% for module in macros.modules %}
          <span class="module">{{ module.name }} ({{ module.line_count }}ì¤„{% if module.obfuscated %}, ë‚œë…í™”{% endif %})</span>
        {% endfor %}
      </div>
      {% endif %}
    </div>
    {% endif %}

    {% set strings = data.analysis_report.features.strings if data.analysis_report and data.analysis_report.features else {} %}
    {% if strings.urls %}
    <div class="analysis-section">
      <h3>ë„¤íŠ¸ì›Œí¬ ì§€í‘œ</h3>
      <div class="urls">
        <strong>ë°œê²¬ëœ URL:</strong>
        {% for url in strings.urls[:10] %}
          <div class="url-item"><code>{{ url }}</code></div>
        {% endfor %}
        {% if strings.urls|length > 10 %}
          <div class="more">... ë° {{ strings.urls|length - 10 }}ê°œ ë”</div>
        {% endif %}
      </div>
    </div>
    {% endif %}

    {% set security = data.analysis_report.features.security_indicators if data.analysis_report and data.analysis_report.features else {} %}
    {% if security %}
    <div class="analysis-section">
      <h3>ë³´ì•ˆ ì§€í‘œ</h3>
      <div class="meta">
        MOTW: {{ "âœ“" if security.motw_present else "âœ—" }} &nbsp;â€¢&nbsp;
        ë§¤í¬ë¡œ ë³´ì•ˆ: {{ security.macro_security_hint or "unknown" }}
        {% if security.digital_signature and security.digital_signature.signed %}
        &nbsp;â€¢&nbsp; ë””ì§€í„¸ ì„œëª…: <strong>ìˆìŒ</strong>
        {% if security.digital_signature.publisher %}
        ({{ security.digital_signature.publisher }})
        {% endif %}
        {% endif %}
      </div>
    </div>
    {% endif %}

    {% set virustotal = data.analysis_report.virustotal if data.analysis_report else None %}
    {% if virustotal and virustotal.available %}
    {% set scan_summary = virustotal.scan_summary %}
    {% set detection_rate = (scan_summary.detection_rate or 0)|float %}
    {% set malicious_count = scan_summary.malicious or 0 %}
    {% set total_scans = scan_summary.total or 0 %}
    {% set severity_class = 'safe' %}
    {% set severity_label = 'ì•ˆì „í•¨' %}
    {% set severity_icon = 'ğŸ›¡ï¸' %}
    {% set severity_hint = 'ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” íŒŒì¼ì…ë‹ˆë‹¤' %}
    {% set action_hint = 'ì´ íŒŒì¼ì€ ëŒ€ë¶€ë¶„ì˜ ë³´ì•ˆ í”„ë¡œê·¸ë¨ì—ì„œ ì•ˆì „í•˜ë‹¤ê³  íŒì •í–ˆìŠµë‹ˆë‹¤. ì•ˆì‹¬í•˜ê³  ì‚¬ìš©í•˜ì„¸ìš”.' %}
    {% if detection_rate >= 50 or malicious_count >= 10 %}
      {% set severity_class = 'critical' %}
      {% set severity_label = 'ë§¤ìš° ìœ„í—˜' %}
      {% set severity_icon = 'ğŸš¨' %}
      {% set severity_hint = 'ì•…ì„± íŒŒì¼ì¼ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤' %}
      {% set action_hint = 'ì¦‰ì‹œ íŒŒì¼ì„ ì‚­ì œí•˜ê³  ì‹œìŠ¤í…œì„ ì ê²€í•˜ì„¸ìš”. ì´ íŒŒì¼ì„ ì‹¤í–‰í•˜ì§€ ë§ˆì„¸ìš”.' %}
    {% elif detection_rate >= 20 or malicious_count >= 5 %}
      {% set severity_class = 'danger' %}
      {% set severity_label = 'ìœ„í—˜' %}
      {% set severity_icon = 'âš ï¸' %}
      {% set severity_hint = 'ì•…ì„± íŒŒì¼ì¼ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤' %}
      {% set action_hint = 'ì´ íŒŒì¼ì„ ì—´ì§€ ë§ˆì„¸ìš”. ê²©ë¦¬í•˜ê±°ë‚˜ ì‚­ì œë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.' %}
    {% elif detection_rate > 0 %}
      {% set severity_class = 'warning' %}
      {% set severity_label = 'ì£¼ì˜ í•„ìš”' %}
      {% set severity_icon = 'âš¡' %}
      {% set severity_hint = 'ì¼ë¶€ ì˜ì‹¬ìŠ¤ëŸ¬ìš´ íŠ¹ì§•ì´ ë°œê²¬ë¨' %}
      {% set action_hint = 'ì‹ ì¤‘í•˜ê²Œ ê²€í†  í›„ ì‚¬ìš©í•˜ì„¸ìš”. ê°€ëŠ¥í•˜ë©´ ë‹¤ë¥¸ ì¶œì²˜ì—ì„œ ë™ì¼í•œ íŒŒì¼ì„ í™•ì¸í•´ë³´ì„¸ìš”.' %}
    {% endif %}
    
    <div class="analysis-section vt-section">
      <h3>ğŸ” VirusTotal ë°”ì´ëŸ¬ìŠ¤ ê²€ì‚¬ ê²°ê³¼</h3>
      
      <!-- ìœ„í—˜ë„ ìš”ì•½ ì¹´ë“œ -->
      <div class="vt-risk-card severity-{{ severity_class }}">
        <div class="vt-risk-header">
          <div class="vt-risk-icon">{{ severity_icon }}</div>
          <div class="vt-risk-main">
            <div class="vt-risk-label">{{ severity_label }}</div>
            <div class="vt-risk-score">{{ malicious_count }}/{{ total_scans }} ê°œ í”„ë¡œê·¸ë¨ì´ ìœ„í—˜í•˜ë‹¤ê³  íŒì •</div>
          </div>
          <div class="vt-risk-percentage">{{ detection_rate|round(1) }}%</div>
        </div>
        <div class="vt-risk-hint">{{ severity_hint }}</div>
        <div class="vt-action-guide">
          <strong>ê¶Œì¥ ì¡°ì¹˜:</strong> {{ action_hint }}
        </div>
      </div>

      <!-- ê²€ì‚¬ ì •ë³´ -->
      <div class="vt-info-grid">
        <div class="vt-info-item">
          <div class="vt-info-label">ê²€ì‚¬ ì—”ì§„ ìˆ˜</div>
          <div class="vt-info-value">{{ total_scans }}ê°œ</div>
          <div class="vt-info-desc">ì „ ì„¸ê³„ ë³´ì•ˆ íšŒì‚¬ë“¤ì˜ ë°”ì´ëŸ¬ìŠ¤ ê²€ì‚¬ í”„ë¡œê·¸ë¨</div>
        </div>
        <div class="vt-info-item">
          <div class="vt-info-label">ìœ„í—˜ íƒì§€</div>
          <div class="vt-info-value severity-{{ severity_class }}">{{ malicious_count }}ê°œ</div>
          <div class="vt-info-desc">ì•…ì„±ì½”ë“œë¼ê³  íŒì •í•œ í”„ë¡œê·¸ë¨ ìˆ˜</div>
        </div>
        {% if virustotal.threat_info.suggested_label %}
        <div class="vt-info-item">
          <div class="vt-info-label">ìœ„í˜‘ ìœ í˜•</div>
          <div class="vt-info-value">{{ virustotal.threat_info.suggested_label }}</div>
          <div class="vt-info-desc">ë°œê²¬ëœ ì•…ì„±ì½”ë“œì˜ ì¢…ë¥˜</div>
        </div>
        {% endif %}
        {% if virustotal.timestamps.last_analysis %}
        <div class="vt-info-item">
          <div class="vt-info-label">ê²€ì‚¬ ì¼ì‹œ</div>
          <div class="vt-info-value">{{ virustotal.timestamps.last_analysis.split(' ')[0] }}</div>
          <div class="vt-info-desc">ê°€ì¥ ìµœê·¼ì— ê²€ì‚¬í•œ ë‚ ì§œ</div>
        </div>
        {% endif %}
      </div>

      <!-- íƒœê·¸ ì •ë³´ -->
      {% if virustotal.threat_info.tags %}
      <div class="vt-tags-section">
        <div class="vt-tags-label">ğŸ·ï¸ íŒŒì¼ íŠ¹ì§•</div>
        <div class="vt-tags">
          {% for tag in virustotal.threat_info.tags %}
          <span class="vt-tag">{{ tag }}</span>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- ìƒì„¸ ê²€ì‚¬ ê²°ê³¼ -->
      {% if virustotal.vendor_results %}
      <div class="vt-details-section">
        <div class="vt-details-header">
          <span>ğŸ“‹ ì£¼ìš” ë³´ì•ˆ íšŒì‚¬ë³„ ê²€ì‚¬ ê²°ê³¼</span>
          <button class="vt-toggle-btn" onclick="toggleVtDetails()">ìƒì„¸ë³´ê¸°</button>
        </div>
        <div class="vt-vendor-container" id="vtVendorContainer" style="display: none;">
          <div class="vt-vendor-summary">
            {% set detected_vendors = [] %}
            {% set clean_vendors = [] %}
            {% for vendor, result in virustotal.vendor_results.items() %}
              {% if result.detected %}
                {% set _ = detected_vendors.append(vendor) %}
              {% else %}
                {% set _ = clean_vendors.append(vendor) %}
              {% endif %}
            {% endfor %}
            
            {% if detected_vendors %}
            <div class="vt-vendor-group danger">
              <div class="vt-vendor-group-title">âš ï¸ ìœ„í—˜í•˜ë‹¤ê³  íŒì •í•œ íšŒì‚¬ ({{ detected_vendors|length }}ê°œ)</div>
              <div class="vt-vendor-list">
                {% for vendor in detected_vendors %}
                <div class="vt-vendor-item danger">
                  <div class="vt-vendor-name">{{ vendor }}</div>
                  <div class="vt-vendor-result">{{ virustotal.vendor_results[vendor].result or virustotal.vendor_results[vendor].category }}</div>
                </div>
                {% endfor %}
              </div>
            </div>
            {% endif %}
            
            {% if clean_vendors %}
            <div class="vt-vendor-group safe">
              <div class="vt-vendor-group-title">âœ… ì•ˆì „í•˜ë‹¤ê³  íŒì •í•œ íšŒì‚¬ ({{ clean_vendors|length }}ê°œ)</div>
              <div class="vt-vendor-list collapsed" id="cleanVendorList">
                {% for vendor in clean_vendors[:5] %}
                <div class="vt-vendor-item safe">
                  <div class="vt-vendor-name">{{ vendor }}</div>
                  <div class="vt-vendor-result">ì •ìƒ íŒŒì¼</div>
                </div>
                {% endfor %}
                {% if clean_vendors|length > 5 %}
                <div class="vt-show-more" onclick="showMoreVendors()">+ {{ clean_vendors|length - 5 }}ê°œ ë” ë³´ê¸°</div>
                {% endif %}
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
      {% endif %}

      <!-- ì¶”ê°€ ì •ë³´ ë° ë§í¬ -->
      <div class="vt-footer-new">
        <div class="vt-learn-more">
          <strong>ğŸ’¡ ë„ì›€ë§:</strong> VirusTotalì€ ì „ ì„¸ê³„ 70ì—¬ ê°œ ë³´ì•ˆ íšŒì‚¬ì˜ ë°”ì´ëŸ¬ìŠ¤ ê²€ì‚¬ ì—”ì§„ì„ ì‚¬ìš©í•˜ì—¬ íŒŒì¼ì˜ ì•ˆì „ì„±ì„ ê²€ì¦í•˜ëŠ” ë¬´ë£Œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.
        </div>
        <div class="vt-links">
          <a href="{{ virustotal.permalink }}" target="_blank" rel="noopener" class="vt-link-btn">
            ğŸ”— VirusTotalì—ì„œ ìì„¸íˆ ë³´ê¸°
          </a>
          {% if virustotal.timestamps.first_submission %}
          <span class="vt-date-info">ìµœì´ˆ ì—…ë¡œë“œ: {{ virustotal.timestamps.first_submission.split(' ')[0] }}</span>
          {% endif %}
        </div>
      </div>
    </div>
    {% elif virustotal and not virustotal.available %}
    <div class="analysis-section vt-section">
      <h3>ğŸ” VirusTotal ë°”ì´ëŸ¬ìŠ¤ ê²€ì‚¬ ê²°ê³¼</h3>
      <div class="vt-error-card">
        {% if virustotal.error == 'file_not_found' %}
        <div class="vt-error-icon">â“</div>
        <div class="vt-error-content">
          <div class="vt-error-title">ê²€ì‚¬ ì •ë³´ ì—†ìŒ</div>
          <div class="vt-error-desc">ì´ íŒŒì¼ì€ ì•„ì§ VirusTotalì— ì—…ë¡œë“œëœ ì ì´ ì—†ìŠµë‹ˆë‹¤.</div>
          <div class="vt-error-action">ì§ì ‘ VirusTotalì— íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ê²€ì‚¬ë¥¼ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        </div>
        {% elif virustotal.error == 'rate_limit' %}
        <div class="vt-error-icon">â³</div>
        <div class="vt-error-content">
          <div class="vt-error-title">ì¼ì‹œì  ì œí•œ</div>
          <div class="vt-error-desc">ë„ˆë¬´ ë§ì€ ìš”ì²­ìœ¼ë¡œ ì¸í•´ ì ì‹œ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
          <div class="vt-error-action">ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜ VirusTotal ì›¹ì‚¬ì´íŠ¸ë¥¼ ì§ì ‘ ì´ìš©í•´ì£¼ì„¸ìš”.</div>
        </div>
        {% else %}
        <div class="vt-error-icon">âŒ</div>
        <div class="vt-error-content">
          <div class="vt-error-title">ê²€ì‚¬ ì˜¤ë¥˜</div>
          <div class="vt-error-desc">VirusTotal ì„œë¹„ìŠ¤ ì—°ê²° ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>
          <div class="vt-error-action">ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>
  {% else %}
  <div class="card">
    <h2>ë¶„ì„ ê²°ê³¼</h2>
    <div class="meta">ë¶„ì„ ê²°ê³¼ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
  </div>
  {% endif %}

  <div class="card">
    <h2>Excerpt</h2>
    <pre>{{ data.content_excerpt }}</pre>
  </div>

  <div class="footer">MalOffice MVP â€” generated by FastAPI + Redis</div>

  <script>
    function toggleVtDetails() {
      const container = document.getElementById('vtVendorContainer');
      const btn = document.querySelector('.vt-toggle-btn');
      
      if (container.style.display === 'none') {
        container.style.display = 'block';
        btn.textContent = 'ì ‘ê¸°';
      } else {
        container.style.display = 'none';
        btn.textContent = 'ìƒì„¸ë³´ê¸°';
      }
    }

    function showMoreVendors() {
      const cleanList = document.getElementById('cleanVendorList');
      const showMoreBtn = document.querySelector('.vt-show-more');
      
      if (cleanList.classList.contains('collapsed')) {
        cleanList.classList.remove('collapsed');
        showMoreBtn.textContent = 'ì ‘ê¸°';
      } else {
        cleanList.classList.add('collapsed');
        const hiddenCount = cleanList.querySelectorAll('.vt-vendor-item:nth-child(n+6)').length;
        showMoreBtn.textContent = `+ ${hiddenCount}ê°œ ë” ë³´ê¸°`;
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      const style = document.createElement('style');
      style.textContent = `
        .vt-vendor-list.collapsed .vt-vendor-item:nth-child(n+6) {
          display: none;
        }
      `;
      document.head.appendChild(style);
    });
  </script>
</body>
</html>
