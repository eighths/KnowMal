<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>KnowMal - 문서 악성 코드 탐지 리포트</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🛡️</text></svg>">
  <link rel="stylesheet" href="/static/css/report.css?v=11">
</head>
<body>
  {% if data.analysis_report or data.virustotal or data.ai_prediction %}
  
  {# === 압축 파일 여부 및 내부 파일 확인 === #}
  {% set analysis_report = data.analysis_report or data.report %}
  {% set is_archive = false %}
  {% set embedded_files = [] %}
  {% if analysis_report and analysis_report.file %}
    {% set is_archive = analysis_report.file.is_archive or false %}
    {% set embedded_files = analysis_report.embedded_files or [] %}
  {% endif %}
  
  {# === Gemini 설명 전역 폴백 === #}
  <!-- DEBUG: data 키들 = {{ data.keys() | list }} -->
  <!-- DEBUG: data.gemini_explanation 존재 = {{ data.gemini_explanation is not none }} -->
  <!-- DEBUG: data.analysis_report.gemini_explanation 존재 = {{ (data.analysis_report.gemini_explanation if data.analysis_report else None) is not none }} -->
  {% set gx = (
      data.gemini_explanation
      or (data.report.gemini_explanation if data.report else None)
      or (data.report.report.gemini_explanation if (data.report and data.report.report) else None)
      or (data.analysis_report.gemini_explanation if data.analysis_report else None)
      or (data.cache_data.gemini_explanation if data.cache_data else None)
  ) %}
  <!-- DEBUG: gx 값 = {{ gx is not none }}, gx 타입 = {{ gx.__class__.__name__ if gx else 'None' }} -->

      <!-- 통합 파일 정보 카드 -->
      <div class="unified-file-card">
    <!-- 브랜딩 헤더 -->
        <div class="card-header-section">
        <div class="service-branding">
            <div class="service-logo">
              <img src="/static/images/KnowMal_logo.png" alt="KnowMal" class="logo-image">
            </div>
            <div class="service-info">
                <h1 class="service-name">KnowMal</h1>
                <p class="service-tagline">문서 악성 코드 탐지 서비스</p>
            </div>
        </div>
        <div class="powered-by">
            <span>Powered by AI_Know</span>
          </div>
        </div>

        <!-- 압축 파일 정보 카드 -->      
        {% if is_archive and embedded_files and embedded_files|length > 0 and data.analysis_report.features.structure %}
        <div class="file-card" style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border: 1px solid #e2e8f0; margin-bottom: 20px;">
          <div style="padding: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
              <div>
                <h3 style="font-weight: 700; color: #475569; font-size: 18px; margin: 0 0 8px 0;">📦 압축 파일 정보</h3>
                <span style="font-size: 13px; color: #64748b; background: #e2e8f0; padding: 4px 10px; border-radius: 6px; display: inline-block;">{{ data.analysis_report.features.structure.container_type.upper() }} 포맷</span>
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
              <div style="background: #ffffff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px;">
                <div style="color: #64748b; font-size: 13px; margin-bottom: 6px;">압축 파일명</div>
                <div style="color: #334155; font-weight: 600; font-size: 15px; word-break: break-all;">{{ data.filename }}</div>
              </div>
              
              <div style="background: #ffffff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px;">
                <div style="color: #64748b; font-size: 13px; margin-bottom: 6px;">내부 파일 수</div>
                <div style="color: #334155; font-weight: 600; font-size: 15px;">{{ embedded_files|length }}개</div>
              </div>
              
              {% if data.analysis_report.features.structure.malicious_files_count %}
              <div style="background: #ffffff; border: 1px solid #fca5a5; border-radius: 8px; padding: 16px;">
                <div style="color: #64748b; font-size: 13px; margin-bottom: 6px;">악성 파일 수</div>
                <div style="color: #dc2626; font-weight: 700; font-size: 15px;">{{ data.analysis_report.features.structure.malicious_files_count }}개</div>
              </div>
              {% endif %}
              
              {% if data.analysis_report.risk_assessment.overall_risk_score %}
              <div style="background: #ffffff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px;">
                <div style="color: #64748b; font-size: 13px; margin-bottom: 6px;">전체 위험도</div>
                {% set risk_score = data.analysis_report.risk_assessment.overall_risk_score %}
                {% if risk_score > 0.5 %}
                  {% set risk_color_class = 'text-danger' %}
                {% elif risk_score > 0.1 %}
                  {% set risk_color_class = 'text-warning' %}
                {% else %}
                  {% set risk_color_class = 'text-safe' %}
                {% endif %}
                <div class="risk-percentage {{ risk_color_class }}">{{ "%.1f"|format(risk_score * 100) }}%</div>
              </div>
              {% endif %}
            </div>
            
            <!-- 악성 파일 목록 표시 -->
            {% if data.analysis_report.features.structure.malicious_files_count and data.analysis_report.features.structure.malicious_files_count > 0 %}
            <div style="margin-top: 20px; padding: 16px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px;">
              <div style="color: #dc2626; font-weight: 600; font-size: 14px; margin-bottom: 12px;">⚠️ 발견된 악성 파일</div>
              <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                <span style="background: #dc2626; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500;">{{ data.filename }}</span>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
        {% endif %}

        <!-- 파일 정보 카드 -->
        <div class="file-card">
      {% set virustotal = (
          data.virustotal
          if data.virustotal
          else (data.analysis_report.virustotal
                if data.analysis_report
                else (data.report.virustotal if data.report else None))
      ) %}
      
      {# AI 탭 데이터 먼저 준비 (AI 탭과 동일한 로직) #}
      {% set ai_data_for_card = data %}
      
      {% if is_archive and embedded_files and embedded_files|length > 0 %}
        {% set most_dangerous_card = namespace(item=None, threat_count=0, has_malicious=false) %}
        
        {% for item in embedded_files %}
          {% set rep = item.get('report') %}
          {% if rep and rep.ai_prediction and rep.ai_prediction.ai_analysis and rep.ai_prediction.ai_analysis.predicted_types %}
            {% set threat_count = 0 %}
            {% for t in rep.ai_prediction.ai_analysis.predicted_types %}
              {% if t != 'Normal' %}
                {% set threat_count = threat_count + 1 %}
              {% endif %}
            {% endfor %}
            {% if threat_count > 0 %}
              {% set most_dangerous_card.has_malicious = true %}
              {% if threat_count > most_dangerous_card.threat_count %}
                {% set most_dangerous_card.item = item %}
                {% set most_dangerous_card.threat_count = threat_count %}
              {% endif %}
            {% endif %}
          {% endif %}
        {% endfor %}
        
        {% if most_dangerous_card.item %}
          {% set rep = most_dangerous_card.item.report %}
          {% set ai_data_for_card = {"ai_prediction": rep.ai_prediction, "filename": most_dangerous_card.item.filename} %}
        {% elif most_dangerous_card.has_malicious == false %}
          {% if embedded_files and embedded_files|length > 0 %}
            {% set first_file = embedded_files[0] %}
            {% if first_file.report and first_file.report.ai_prediction %}
              {% set ai_data_for_card = {"ai_prediction": first_file.report.ai_prediction, "filename": first_file.filename} %}
            {% endif %}
          {% endif %}
        {% endif %}
      {% endif %}
      
      {# AI 탭 데이터에서 위협 추출 #}
      {% set ai_has_threat = false %}
      {% set ai_threats = [] %}
      {% set ai_is_normal = false %}
      
      {% if ai_data_for_card.ai_prediction and ai_data_for_card.ai_prediction.ai_analysis and ai_data_for_card.ai_prediction.ai_analysis.predicted_types %}
        {% set predicted_types = ai_data_for_card.ai_prediction.ai_analysis.predicted_types %}
        {% for threat in predicted_types %}
          {% if threat != 'Normal' %}
            {% set _ = ai_threats.append(threat) %}
          {% else %}
            {% set ai_is_normal = true %}
          {% endif %}
        {% endfor %}
        {% if ai_threats %}
          {% set ai_has_threat = true %}
        {% endif %}
      {% endif %}
      
      {% set vt_detection_rate = 0 %}
      {% set vt_malicious_count = 0 %}
      {% set vt_total_scans = 0 %}
      {% if virustotal and virustotal.available %}
        {% set scan_summary = virustotal.scan_summary %}
        {% set vt_detection_rate = (scan_summary.detection_rate or 0)|float %}
        {% set vt_malicious_count = scan_summary.malicious or 0 %}
        {% set vt_total_scans = scan_summary.total or 0 %}
      {% endif %}

      {% if ai_has_threat %}
          <!-- 악성 파일 레이아웃 (2번째 사진 스타일) -->
          <div class="malicious-file-layout">
            <!-- 상단: 원형 그래프 + 파일 정보 -->
            <div class="file-analysis-header">
              <!-- 왼쪽: 원형 그래프 (VirusTotal 결과) -->
              <div class="virus-total-circle">
                <div class="circular-progress" data-percentage="{{ vt_detection_rate|round(1) }}">
                  <svg class="progress-ring" width="140" height="140">
                    <defs>
                      <linearGradient id="dangerGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color:#ef4444;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#dc2626;stop-opacity:1" />
                      </linearGradient>
                    </defs>
                    <!-- 배경 트랙 (연한 회색 원) -->
                    <circle class="progress-ring-track" cx="70" cy="70" r="60" stroke="#f3f4f6" stroke-width="12" fill="transparent"/>
                    <!-- 진행 상태 호 (빨간색, 퍼센트에 따라 채워짐) -->
                    <circle class="progress-ring-fill" cx="70" cy="70" r="60" fill="transparent" stroke-width="12" stroke-linecap="round"
                            stroke="url(#dangerGradient)" 
                            stroke-dasharray="377 377" 
                            stroke-dashoffset="{{ 377 - (vt_detection_rate * 377 / 100) }}"
                            transform="rotate(-90 70 70)"/>
                  </svg>
                  <div class="progress-text">
                    <div class="progress-status malicious-status">Malicious</div>
                  </div>
                </div>
                <div class="progress-details">
                  <div class="progress-description">탐지한 보안 회사</div>
                  <div class="progress-count">{{ vt_malicious_count }}/{{ vt_total_scans }}개</div>
                  <div class="progress-percentage">{{ vt_detection_rate|round(1) }}%</div>
                </div>
              </div>
              
              <!-- 오른쪽: 파일 정보 -->
              <div class="file-info-section">
                <div class="file-info-item">
                  <div class="info-label">파일명</div>
                  <div class="info-value">{{ data.filename }}</div>
                </div>
                <div class="file-info-item">
                  <div class="info-label">크기</div>
                  <div class="info-value">{{ (data.size_bytes / 1024 / 1024)|round(1) }} MB</div>
                </div>
                <div class="file-info-item">
                  <div class="info-label">SHA-256</div>
                  <div class="info-value">{{ (data.sha256[:8] + '...' + data.sha256[-4:]) if data.sha256 else 'unknown' }}</div>
                </div>
                <div class="file-info-item">
                  <div class="info-label">문서 유형</div>
                  {% set mime_type = data.mime_type or "알 수 없음" %}
                  {% set friendly_type = "알 수 없음" %}
                  {% if mime_type.startswith('application/msword') or mime_type.startswith('application/vnd.openxmlformats-officedocument.wordprocessingml') %}
                    {% set friendly_type = "Word 문서" %}
                  {% elif mime_type.startswith('application/vnd.ms-excel') or mime_type.startswith('application/vnd.openxmlformats-officedocument.spreadsheetml') %}
                    {% set friendly_type = "Excel 문서" %}
                  {% elif mime_type.startswith('application/vnd.ms-powerpoint') or mime_type.startswith('application/vnd.openxmlformats-officedocument.presentationml') %}
                    {% set friendly_type = "PowerPoint 문서" %}
                  {% elif mime_type.startswith('application/pdf') %}
                    {% set friendly_type = "PDF 문서" %}
                  {% elif mime_type.startswith('text/') %}
                    {% set friendly_type = "텍스트 파일" %}
                  {% elif mime_type.startswith('image/') %}
                    {% set friendly_type = "이미지 파일" %}
                  {% elif mime_type.startswith('video/') %}
                    {% set friendly_type = "동영상 파일" %}
                  {% elif mime_type.startswith('audio/') %}
                    {% set friendly_type = "오디오 파일" %}
                  {% elif mime_type.startswith('application/zip') or mime_type.startswith('application/x-rar') %}
                    {% set friendly_type = "압축 파일" %}
                  {% elif mime_type.startswith('application/') %}
                    {% set friendly_type = "응용 프로그램" %}
                  {% else %}
                    {% set friendly_type = mime_type %}
                  {% endif %}
                  <div class="info-value">{{ friendly_type }}</div>
                </div>
              </div>
            </div>
            
            <!-- 구분선 -->
            <div class="section-divider"></div>
            
            <!-- 하단: 액션 버튼 -->
            <!-- DEBUG: ai_has_threat={{ ai_has_threat }}, ai_threats={{ ai_threats }}, len={{ ai_threats|length }} -->
            {% if ai_threats and ai_threats|length > 0 %}
            <div class="file-actions-and-tags">
              <div class="action-buttons">
                {% for threat in ai_threats %}
                  <button class="action-button malicious-button">{{ threat }}</button>
                {% endfor %}
              </div>
            </div>
            {% endif %}
            
            <!-- 위험 태그들 -->
            {% if ai_threats and ai_threats|length > 0 %}
            {% set all_tags = [] %}
            {% for threat in ai_threats %}
              {% if threat == 'Download' %}
                {% set _ = all_tags.append({'text': '추가 악성코드 설치', 'class': 'dot-red'}) %}
              {% elif threat == 'Backdoor' %}
                {% set _ = all_tags.append({'text': '원격 제어', 'class': 'dot-orange'}) %}
                {% set _ = all_tags.append({'text': '데이터 탈취 가능', 'class': 'dot-purple'}) %}
              {% elif threat == 'Botnet' %}
                {% set _ = all_tags.append({'text': 'DDoS 공격', 'class': 'dot-yellow'}) %}
                {% set _ = all_tags.append({'text': '스팸 발송', 'class': 'dot-blue'}) %}
                {% set _ = all_tags.append({'text': '암호화폐 채굴', 'class': 'dot-green'}) %}
              {% elif threat == 'Infiltration' %}
                {% set _ = all_tags.append({'text': '데이터 유출', 'class': 'dot-red'}) %}
                {% set _ = all_tags.append({'text': '시스템 파괴', 'class': 'dot-orange'}) %}
                {% set _ = all_tags.append({'text': '개인정보 침해', 'class': 'dot-purple'}) %}
              {% else %}
                {% set _ = all_tags.append({'text': threat, 'class': 'dot-gray'}) %}
              {% endif %}
            {% endfor %}
            
            <!-- 태그 컨테이너 -->
            <div class="threat-tags">
              <!-- 모든 태그를 4개씩 줄바꿈하여 표시 -->
              {% for tag_row in all_tags|batch(4) %}
                <div class="threat-tags-row">
                  {% for tag in tag_row %}
                    <div class="threat-tag gray-tag {{ tag.class }}">
                      <span class="tag-text">{{ tag.text }}</span>
                    </div>
                  {% endfor %}
                </div>
              {% endfor %}
            </div>
            {% endif %}
          </div>
      {% else %}
          <!-- 정상 파일 레이아웃 -->
          <div class="normal-file-layout">
            <!-- 상단: 원형 그래프 + 파일 정보 -->
            <div class="file-analysis-header">
              <!-- 왼쪽: 원형 그래프 (VirusTotal 결과) -->
              <div class="virus-total-circle">
                <div class="circular-progress is-normal" data-percentage="0">
                  <svg class="progress-ring" width="180" height="180">
                    <defs>
                      <linearGradient id="safeGradient2" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#15803d;stop-opacity:0.9" />
                        <stop offset="30%" style="stop-color:#22c55e;stop-opacity:1" />
                        <stop offset="70%" style="stop-color:#16a34a;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#15803d;stop-opacity:0.9" />
                      </linearGradient>
                    </defs>
                    <!-- 배경 트랙 (Normal 상태에서는 투명하게 처리하여 그라데이션만 보이도록) -->
                    <circle class="progress-ring-track" cx="90" cy="90" r="75" stroke="transparent" stroke-width="18" fill="transparent"/>
                    <!-- 진행 상태 호 (Normal 상태일 때 항상 100% 채워진 초록색 그라데이션) -->
                    <circle class="progress-ring-fill" cx="90" cy="90" r="75" fill="transparent" stroke-width="18" stroke-linecap="round"
                            stroke="url(#safeGradient2)" 
                            stroke-dasharray="471 471" 
                            stroke-dashoffset="0"
                            transform="rotate(-90 90 90)"
                            style="stroke-dasharray: 471.239, 471.239; stroke-dashoffset: 0; transition: none;"/>
                  </svg>
                  <div class="progress-text">
                    <div class="progress-status normal-status">Normal</div>
                  </div>
                </div>
                <div class="progress-details" style="display: none;">
                  <div class="progress-description">안전하다고 판정한 회사</div>
                  <div class="progress-count">{{ vt_total_scans - vt_malicious_count }}/{{ vt_total_scans }}개</div>
                  <div class="progress-percentage">{{ vt_detection_rate|round(1) }}%</div>
                </div>
              </div>
              
              <!-- 오른쪽: 파일 정보 -->
              <div class="file-info-section">
                <div class="file-info-item">
                  <div class="info-label">파일명</div>
                  <div class="info-value">{{ data.filename }}</div>
                </div>
                <div class="file-info-item">
                  <div class="info-label">크기</div>
                  <div class="info-value">{{ (data.size_bytes / 1024 / 1024)|round(1) }} MB</div>
                </div>
                <div class="file-info-item">
                  <div class="info-label">SHA-256</div>
                  <div class="info-value">{{ (data.sha256[:8] + '...' + data.sha256[-4:]) if data.sha256 else 'unknown' }}</div>
                </div>
                <div class="file-info-item">
                  <div class="info-label">문서 유형</div>
                  {% set mime_type = data.mime_type or "알 수 없음" %}
                  {% set friendly_type = "알 수 없음" %}
                  {% if mime_type.startswith('application/msword') or mime_type.startswith('application/vnd.openxmlformats-officedocument.wordprocessingml') %}
                    {% set friendly_type = "Word 문서" %}
                  {% elif mime_type.startswith('application/vnd.ms-excel') or mime_type.startswith('application/vnd.openxmlformats-officedocument.spreadsheetml') %}
                    {% set friendly_type = "Excel 문서" %}
                  {% elif mime_type.startswith('application/vnd.ms-powerpoint') or mime_type.startswith('application/vnd.openxmlformats-officedocument.presentationml') %}
                    {% set friendly_type = "PowerPoint 문서" %}
                  {% elif mime_type.startswith('application/pdf') %}
                    {% set friendly_type = "PDF 문서" %}
                  {% elif mime_type.startswith('text/') %}
                    {% set friendly_type = "텍스트 파일" %}
                  {% elif mime_type.startswith('image/') %}
                    {% set friendly_type = "이미지 파일" %}
                  {% elif mime_type.startswith('video/') %}
                    {% set friendly_type = "동영상 파일" %}
                  {% elif mime_type.startswith('audio/') %}
                    {% set friendly_type = "오디오 파일" %}
                  {% elif mime_type.startswith('application/zip') or mime_type.startswith('application/x-rar') %}
                    {% set friendly_type = "압축 파일" %}
                  {% elif mime_type.startswith('application/') %}
                    {% set friendly_type = "응용 프로그램" %}
                  {% else %}
                    {% set friendly_type = mime_type %}
                  {% endif %}
                  <div class="info-value">{{ friendly_type }}</div>
                </div>
              </div>
            </div>
            
            <!-- 구분선 -->
            <div class="section-divider"></div>
            
            <!-- 하단: SAFE 태그 -->
            <div class="file-actions-and-tags">
              <div class="safe-status-tag">
                <span class="safe-text">SAFE</span>
              </div>
            </div>
            
            <!-- 안전 태그들 -->
            <div class="threat-tags">
              <div class="threat-tag gray-tag dot-green">
                <span class="tag-text">디지털 서명 확인됨</span>
              </div>
              <div class="threat-tag gray-tag dot-blue">
                <span class="tag-text">일반 수식 사용</span>
              </div>
              <div class="threat-tag gray-tag dot-green">
                <span class="tag-text">외부 연결 없음</span>
              </div>
            </div>
          </div>
      {% endif %}
        </div>
        </div>
        
        <!-- Gemini 종합 설명 -->
        {# ==== Gemini 종합 설명 (요약/대처) ==== #}
        {% if gx %}
          {% if gx is mapping %}
            <div class="gemini-summary-section">
              <div class="summary-header">
                <span class="summary-title">AI 보안 분석 종합 설명</span>
              </div>

              <div class="summary-content">
                {{ gx.summary }}
              </div>

              <div class="action-content">
                <ul>
                  {% if gx.actions and gx.actions.immediate %}<li>즉시 조치: {{ gx.actions.immediate }}</li>{% endif %}
                  {% if gx.actions and gx.actions.investigate %}<li>조사: {{ gx.actions.investigate }}</li>{% endif %}
                  {% if gx.actions and gx.actions.deep %}<li>심층 대응: {{ gx.actions.deep }}</li>{% endif %}
                </ul>
              </div>
            </div>
          {% else %}
            <div class="gemini-summary-section">
              <div class="summary-header">
                <span class="summary-title">AI 보안 분석 종합 설명</span>
              </div>
              <div class="summary-content">{{ gx }}</div>
            </div>
          {% endif %}
        {% endif %}
        {# ==== /Gemini 종합 설명 ==== #}

      </div>

      <!-- 탭 네비게이션 -->
      <div class="tab-navigation">
        <button class="tab-button active" data-tab="ai-analysis">
          AI 네트워크 행위 예측 결과
        </button>
        <button class="tab-button" data-tab="virustotal">
          VirusTotal 바이러스 검사 결과
        </button>
      </div>

      <!-- AI 네트워크 행위 예측 탭 콘텐츠 -->
      <div id="ai-analysis-tab" class="tab-content active">
        <div class="analysis-section">
          <div class="section-content">
              {% set ai_data = data %}
              
              {% if is_archive and embedded_files and embedded_files|length > 0 %}
                {% set most_dangerous = namespace(item=None, threat_count=0, has_malicious=false) %}
                
                {% for item in embedded_files %}
                  {% set rep = item.get('report') %}
                  {% if rep and rep.ai_prediction and rep.ai_prediction.ai_analysis and rep.ai_prediction.ai_analysis.predicted_types %}
                    {% set threat_count = 0 %}
                    {% for t in rep.ai_prediction.ai_analysis.predicted_types %}
                      {% if t != 'Normal' %}
                        {% set threat_count = threat_count + 1 %}
                      {% endif %}
                    {% endfor %}
                    {% if threat_count > 0 %}
                      {% set most_dangerous.has_malicious = true %}
                      {% if threat_count > most_dangerous.threat_count %}
                        {% set most_dangerous.item = item %}
                        {% set most_dangerous.threat_count = threat_count %}
                      {% endif %}
                    {% endif %}
                  {% endif %}
                {% endfor %}
                
                {% if most_dangerous.item %}
                  {% set rep = most_dangerous.item.report %}
                  {% set ai_data = {"ai_prediction": rep.ai_prediction, "filename": most_dangerous.item.filename} %}
                  {# Gemini 설명 가져오기 #}
                  {% set gx = rep.gemini_explanation or None %}
                {% elif most_dangerous.has_malicious == false %}
                  {# 모든 내부 파일이 Normal인 경우, 첫 번째 파일 사용 #}
                  {% if embedded_files and embedded_files|length > 0 %}
                    {% set first_file = embedded_files[0] %}
                    {% if first_file.report and first_file.report.ai_prediction %}
                      {% set ai_data = {"ai_prediction": first_file.report.ai_prediction, "filename": first_file.filename} %}
                      {% set gx = first_file.report.gemini_explanation or None %}
                    {% endif %}
                  {% endif %}
                {% endif %}
                
              {% else %}
                {# 일반 파일의 경우 원본 data 사용 #}
                {% set gx = (
                    data.gemini_explanation
                    or (data.report.gemini_explanation if data.report else None)
                    or (data.analysis_report.gemini_explanation if data.analysis_report else None)
                ) %}
              {% endif %}
              
              {% if ai_data.ai_prediction and ai_data.ai_prediction.ai_analysis %}
              {% set ai_analysis = ai_data.ai_prediction.ai_analysis %}
              {% set predicted_types = ai_analysis.predicted_types %}
              {# 클래스 확률: confidence_scores → class_probabilities → {} #}
              {% set confidence_scores = ai_analysis.confidence_scores
                                        or ai_analysis.class_probabilities
                                        or {} %}
              {% set model_classes = ai_analysis.model_classes %}
    
          <!-- 위험 항목 그룹 -->
          {% if predicted_types %}
          <div class="prediction-group danger">
            <h3>탐지된 위협</h3>
            {% for class_name in predicted_types %}
            <div class="prediction-item danger">ㄴ
              <div class="icon"></div>
              <div class="content">
                <div class="label">{{ class_name }}</div>
                <div class="desc">
                  {% if class_name == 'Backdoor' %}백도어 - 원격 접근 악성코드
                  {% elif class_name == 'Botnet' %}봇넷 - 네트워크 제어 악성코드
                  {% elif class_name == 'Download' %}다운로더 - 추가 악성코드 다운로드
                  {% elif class_name == 'Infiltration' %}침투 - 시스템 침입 악성코드
                  {% else %}{{ class_name }} - 악성코드 유형
                  {% endif %}
                </div>
              </div>
              <div class="status">탐지됨</div>
            </div>
            {% endfor %}
            </div>
          {% endif %}
          
          <div class="divider"></div>
      
      <div class="ai-footer">
        <div class="ai-disclaimer">
          💡 <strong>AI 분석 안내:</strong> 이 결과는 기계학습 모델에 기반한 예측입니다. 
          실제 악성코드 여부는 전문 보안 도구를 통해 확인하시기 바랍니다.
              </div>
            </div>
            
            <!-- Gemini XAI 설명 -->
            {# ==== Gemini XAI 설명 (근거) ==== #}
            {# Normal이 아닐 때만 표시 #}
            {% set hard_labels = ai_data.ai_prediction.ai_analysis.predicted_types if (ai_data.ai_prediction and ai_data.ai_prediction.ai_analysis) else [] %}
            {% set is_only_normal = hard_labels|length == 1 and hard_labels[0] == 'Normal' %}
            {% if gx and not is_only_normal %}
              {% if gx is mapping and gx.xai %}
                <div class="gemini-xai-section">
                  <div class="xai-header">
                    <span class="xai-title">AI 분석 근거 (XAI)</span>
                  </div>

                  <div class="xai-content">
                    {% if gx.xai.bullets %}
                      <ul>
                        {% for b in gx.xai.bullets %}
                          <li>{{ b }}</li>
                        {% endfor %}
                      </ul>
                    {% endif %}
                  </div>
                </div>
              {% else %}
                <div class="gemini-xai-section">
                  <div class="xai-header">
                    <span class="xai-title">AI 분석 근거 (XAI)</span>
                  </div>
                  <div class="xai-content">{{ gx }}</div>
                </div>
              {% endif %}
            {% endif %}
            {# ==== /Gemini XAI 설명 ==== #}

            <!-- SHAP 기반 특징 중요도 표시 -->
            {# ==== SHAP 기반 특징 중요도 (XAI) ==== #}
            {# Normal이 아닐 때만 표시 #}
            {% if ai_data.ai_prediction and ai_data.ai_prediction.ai_analysis and not is_only_normal %}
              {% set feature_importance = ((ai_data.ai_prediction.ai_analysis.model_info or {}).get('enhanced_features', {}) or {}).get('feature_importance') if ai_data.ai_prediction.ai_analysis.get('model_info') else None %}
              <!-- DEBUG: feature_importance exists = {{ feature_importance is not none }}, count = {{ feature_importance|length if feature_importance else 0 }} -->
              {% if feature_importance %}
              <div class="feature-importance-section">
                <div class="feature-header">
                  <span class="feature-title">SHAP 기반 특징 중요도 (XAI)</span>
                  <span class="feature-subtitle">SHAP(SHapley Additive exPlanations)을 통해 각 악성코드 클래스 판단에 기여한 주요 특징들과 그 영향도를 분석한 결과입니다.</span>
                </div>

                <div class="feature-content">
                  {# 클래스별로 그룹화 #}
                  {% set class_groups = {} %}
                  {% for feature_name, importance in feature_importance.items() %}
                    {% if feature_name.startswith('Backdoor_') %}
                      {% set class_name = 'Backdoor' %}
                    {% elif feature_name.startswith('Botnet_') %}
                      {% set class_name = 'Botnet' %}
                    {% elif feature_name.startswith('Download_') %}
                      {% set class_name = 'Download' %}
                    {% elif feature_name.startswith('Infiltration_') %}
                      {% set class_name = 'Infiltration' %}
                    {% elif feature_name.startswith('Normal_') %}
                      {% set class_name = 'Normal' %}
                    {% elif feature_name.startswith('soft_') %}
                      {% set class_name = 'Soft_' + feature_name.split('_')[1] %}
                    {% else %}
                      {% set class_name = 'Other' %}
                    {% endif %}
                    
                    {% if class_name not in class_groups %}
                      {% set _ = class_groups.update({class_name: []}) %}
                    {% endif %}
                    {% set _ = class_groups[class_name].append((feature_name, importance)) %}
                  {% endfor %}
                  
                  {# 각 클래스별로 박스 표시 #}
                  <div class="class-boxes-container">
                    {% for class_name, features in class_groups.items() %}
                      {% set sorted_features = features|sort(attribute=1, reverse=true) %}
                      <div class="class-box">
                        <div class="class-box-header">
                          {% if class_name == 'Backdoor' %}
                            <span class="class-icon backdoor">🔴</span>
                            <span class="class-name">Backdoor</span>
                          {% elif class_name == 'Botnet' %}
                            <span class="class-icon botnet">🟡</span>
                            <span class="class-name">Botnet</span>
                          {% elif class_name == 'Download' %}
                            <span class="class-icon download">🔵</span>
                            <span class="class-name">Download</span>
                          {% elif class_name == 'Infiltration' %}
                            <span class="class-icon infiltration">🟠</span>
                            <span class="class-name">Infiltration</span>
                          {% elif class_name == 'Normal' %}
                            <span class="class-icon normal">🟢</span>
                            <span class="class-name">Normal</span>
                          {% elif class_name.startswith('Soft_') %}
                            <span class="class-icon soft">⭐</span>
                            <span class="class-name">{{ class_name.replace('Soft_', 'Soft ') }}</span>
                          {% else %}
                            <span class="class-icon">🔍</span>
                            <span class="class-name">{{ class_name }}</span>
                          {% endif %}
                        </div>
                        
                        <div class="class-box-features">
                            {% for feature_name, importance in sorted_features %}
                              <div class="simple-feature-row">
                                <span class="simple-feature-name">
                                  {% if feature_name.startswith('Backdoor_') %}
                                    {{ feature_name.replace('Backdoor_', '').replace('_', ' ') }}
                                  {% elif feature_name.startswith('Botnet_') %}
                                    {{ feature_name.replace('Botnet_', '').replace('_', ' ') }}
                                  {% elif feature_name.startswith('Download_') %}
                                    {{ feature_name.replace('Download_', '').replace('_', ' ') }}
                                  {% elif feature_name.startswith('Infiltration_') %}
                                    {{ feature_name.replace('Infiltration_', '').replace('_', ' ') }}
                                  {% elif feature_name.startswith('Normal_') %}
                                    {{ feature_name.replace('Normal_', '').replace('_', ' ') }}
                                  {% elif feature_name.startswith('soft_') %}
                                    {% set parts = feature_name.replace('soft_', '').split('_', 1) %}
                                    {{ (parts[1] if parts|length > 1 else feature_name).replace('_', ' ') }}
                                  {% else %}
                                    {{ feature_name.replace('_', ' ') }}
                                  {% endif %}
                                </span>
                                <div class="simple-bar-container">
                                  <div class="simple-bar-fill" style="width: {{ (importance * 100)|round(1) }}%">
                                    <span class="simple-percentage-in-bar">{{ (importance * 100)|round(1) }}%</span>
                                  </div>
                                </div>
                              </div>
                            {% endfor %}
                        </div>
                      </div>
                    {% endfor %}
                  </div>

                </div>
              </div>
              {% endif %}
            {% endif %}

          </div>
        </div>
      </div>

      {% else %}
      <div class="no-data-message">
        <div class="no-data-icon">🤖</div>
        <div class="no-data-text">
          {% if is_archive and embedded_files and embedded_files|length > 0 %}
            압축 파일 내부 파일들의 AI 분석 결과가 없습니다.
          {% else %}
            AI 분석 결과가 없습니다.
          {% endif %}
        </div>
      </div>
      {% endif %}

      <!-- VirusTotal 바이러스 검사 결과 탭 콘텐츠 -->
      <div id="virustotal-tab" class="tab-content">
        <div class="analysis-section vt-section">
          <div class="section-content">
            {% set virustotal = data.virustotal if data.virustotal else (data.analysis_report.virustotal if data.analysis_report else None) %}
            {% if virustotal and virustotal.available %}
              {% set scan_summary = virustotal.scan_summary %}
              {% set detection_rate = (scan_summary.detection_rate or 0)|float %}
              {% set malicious_count = scan_summary.malicious or 0 %}
              {% set total_scans = scan_summary.total or 0 %}
              
              {% if detection_rate >= 60 %}
                {% set severity_class = 'critical' %}
                {% set severity_icon = '🚨' %}
                {% set severity_label = '매우 위험' %}
                {% set severity_hint = '악성 파일일 가능성이 매우 높습니다' %}
                {% set action_hint = '즉시 파일을 삭제하고 시스템을 점검하세요. 이 파일을 실행하지 마세요.' %}
              {% elif detection_rate >= 30 %}
                {% set severity_class = 'danger' %}
                {% set severity_icon = '⚠️' %}
                {% set severity_label = '위험' %}
                {% set severity_hint = '악성 파일일 가능성이 높습니다' %}
                {% set action_hint = '파일을 실행하지 마시고 신중하게 검토하세요.' %}
              {% elif detection_rate >= 10 %}
                {% set severity_class = 'warning' %}
                {% set severity_icon = '⚡' %}
                {% set severity_label = '주의' %}
                {% set severity_hint = '일부 의심스러운 특징이 발견됨' %}
                {% set action_hint = '신중하게 검토 후 사용하세요. 가능하면 다른 출처에서 동일한 파일을 확인해보세요.' %}
              {% else %}
                {% set severity_class = 'safe' %}
                {% set severity_icon = '✓' %}
                {% set severity_label = '안전' %}
                {% set severity_hint = '현재까지 악성코드로 탐지되지 않음' %}
                {% set action_hint = '안전하게 사용할 수 있습니다.' %}
              {% endif %}
            {% else %}
              <!-- VirusTotal 데이터가 없는 경우 -->
              {% set detection_rate = 0 %}
              {% set malicious_count = 0 %}
              {% set total_scans = 0 %}
              {% set severity_class = 'safe' %}
              {% set severity_icon = '❓' %}
              {% set severity_label = '검사 불가' %}
              {% set severity_hint = 'VirusTotal에서 이 파일을 검사할 수 없습니다' %}
              {% set action_hint = 'VirusTotal API 키가 설정되지 않았거나 네트워크 오류가 발생했습니다.' %}
            {% endif %}
            
            <!-- 위험도 요약 카드 -->
            <div class="vt-risk-card severity-{{ severity_class }}">
              <div class="vt-risk-header">
                <div class="vt-risk-icon">{{ severity_icon }}</div>
                <div class="vt-risk-main">
                  <div class="vt-risk-label">{{ severity_label }}</div>
                  <div class="vt-risk-score">{{ malicious_count }}/{{ total_scans }} 개 프로그램이 위험하다고 판정</div>
                </div>
                <div class="vt-risk-percentage">{{ detection_rate|round(1) }}%</div>
              </div>
              <div class="vt-risk-hint">{{ severity_hint }}</div>
              <div class="vt-action-guide">
                <strong>권장 조치:</strong> {{ action_hint }}
              </div>
            </div>

            <!-- 검사 정보 -->
            <div class="vt-info-grid">
              <div class="vt-info-item">
                <div class="vt-info-label">검사 엔진 수</div>
                <div class="vt-info-value">{{ total_scans }}개</div>
                <div class="vt-info-desc">전세계 보안 회사들의<br>바이러스 검사 프로그램</div>
              </div>
              <div class="vt-info-item">
                <div class="vt-info-label">위험 탐지</div>
                <div class="vt-info-value severity-{{ severity_class }}">{{ malicious_count }}개</div>
                <div class="vt-info-desc">악성코드라고 판정한 프로그램 수</div>
              </div>
              <div class="vt-info-item">
                <div class="vt-info-label">위협 유형</div>
                {% if virustotal and virustotal.available and virustotal.threat_info %}
                <div class="vt-info-value">{{ virustotal.threat_info.suggested_label or '알 수 없음' }}</div>
                {% else %}
                <div class="vt-info-value">알 수 없음</div>
                {% endif %}
                <div class="vt-info-desc">발견된 악성코드의 종류</div>
              </div>
              <div class="vt-info-item">
                <div class="vt-info-label">검사 일시</div>
                {% if virustotal and virustotal.available and virustotal.timestamps %}
                <div class="vt-info-value">{{ virustotal.timestamps.last_analysis or '알 수 없음' }}</div>
                {% else %}
                <div class="vt-info-value">알 수 없음</div>
                {% endif %}
                <div class="vt-info-desc">가장 최근에 검사한 날짜</div>
              </div>
            </div>

            <!-- 태그 정보 -->
            <div class="vt-tags-section">
              <div class="vt-tags-label">🏷️ 파일 특징</div>
              <div class="vt-tags">
                {% if virustotal and virustotal.available and virustotal.threat_info and virustotal.threat_info.tags %}
                  {% for tag in virustotal.threat_info.tags[:15] %}
                    <span class="vt-tag">{{ tag }}</span>
                  {% endfor %}
                {% else %}
                  <span class="vt-tag">태그 정보 없음</span>
                {% endif %}
              </div>
            </div>

            <!-- 상세 검사 결과 -->
            <div class="vt-details-section">
              <div class="vt-details-header">
                <span>📋 주요 보안 회사별 검사 결과</span>
                <button class="vt-toggle-btn" onclick="toggleVtDetails()">상세보기</button>
              </div>
              <div class="vt-vendor-container" id="vtVendorContainer" style="display: none;">
                <div class="vt-vendor-summary">
                  {% if virustotal and virustotal.available and virustotal.vendor_results %}
                    {% set vendors = virustotal.vendor_results %}
                    {% set bad_list = [] %}
                    {% set good_list = [] %}
                    {% for name, v in vendors.items() %}
                      {% if v.category in ['malicious','suspicious'] %}
                        {% set _ = bad_list.append({'name': name, 'result': v.result or '탐지', 'category': v.category}) %}
                      {% else %}
                        {% set _ = good_list.append({'name': name, 'result': v.result or '정상', 'category': v.category or 'undetected'}) %}
                      {% endif %}
                    {% endfor %}

                    <div class="vt-vendor-group danger">
                      <div class="vt-vendor-group-title">⚠️ 위험하다고 판정한 회사 ({{ bad_list|length }}개)</div>
                      <div class="vt-vendor-notice">
                        <div class="vt-notice-text">주요 보안 회사만 표시됩니다. 전체 회사의 상세 정보는 VirusTotal에서 확인하세요.</div>
                      </div>
                      <div class="vt-vendor-grid">
                        {% for item in bad_list %}
                        <div class="vt-vendor-card danger">
                          <div class="vt-vendor-header">
                            <div class="vt-vendor-name">{{ item.name }}</div>
                            <div class="vt-vendor-status danger">{{ '위험' if item.category=='malicious' else '의심' }}</div>
                          </div>
                          <div class="vt-vendor-result">{{ item.result }}</div>
                        </div>
                        {% endfor %}
                      </div>
                    </div>

                    <div class="vt-vendor-group safe">
                      <div class="vt-vendor-group-title">✅ 안전/미탐지로 판정한 회사 ({{ good_list|length }}개)</div>
                      <div class="vt-vendor-notice">
                        <div class="vt-notice-text">주요 보안 회사만 표시됩니다. 전체 회사의 상세 정보는 VirusTotal에서 확인하세요.</div>
                      </div>
                      <div class="vt-vendor-grid" id="cleanVendorList">
                        {% for item in good_list %}
                        <div class="vt-vendor-card safe">
                          <div class="vt-vendor-header">
                            <div class="vt-vendor-name">{{ item.name }}</div>
                            <div class="vt-vendor-status safe">안전</div>
                          </div>
                          <div class="vt-vendor-result">{{ item.result }}</div>
                        </div>
                        {% endfor %}
                      </div>
                    </div>
                  {% else %}
                    <div class="vt-vendor-group danger">
                      <div class="vt-vendor-group-title">⚠️ 위험하다고 판정한 회사 (0개)</div>
                      <div class="vt-vendor-grid">
                        <div class="vt-vendor-card danger">
                          <div class="vt-vendor-header">
                            <div class="vt-vendor-name">검사 데이터 없음</div>
                            <div class="vt-vendor-status danger">위험</div>
                          </div>
                          <div class="vt-vendor-result">VirusTotal API 호출 필요</div>
                        </div>
                      </div>
                    </div>
                    
                    <div class="vt-vendor-group safe">
                      <div class="vt-vendor-group-title">✅ 안전/미탐지로 판정한 회사 (0개)</div>
                      <div class="vt-vendor-grid" id="cleanVendorList">
                        <div class="vt-vendor-card safe">
                          <div class="vt-vendor-header">
                            <div class="vt-vendor-name">검사 데이터 없음</div>
                            <div class="vt-vendor-status safe">안전</div>
                          </div>
                          <div class="vt-vendor-result">VirusTotal API 호출 필요</div>
                        </div>
                      </div>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- 추가 정보 및 링크 -->
            <div class="vt-footer-new">
              <div class="vt-learn-more">
                <strong>💡 Tip:</strong> VirusTotal은 전 세계 70여 개 보안 엔진으로 파일의 안전성을 교차 검증하는 무료 서비스입니다.
              </div>
              <div class="vt-links">
                {% if virustotal and virustotal.available and virustotal.permalink %}
                <a href="{{ virustotal.permalink }}" target="_blank" rel="noopener" class="vt-link-btn">
                  🔗 VirusTotal에서 자세히 보기
                </a>
                {% else %}
                <a href="https://www.virustotal.com/gui/search/{{ data.sha256 }}" target="_blank" rel="noopener" class="vt-link-btn">
                  🔗 VirusTotal에서 직접 검색
                </a>
                {% endif %}
                {% if virustotal and virustotal.available and virustotal.timestamps %}
                <span class="vt-date-info">최초 업로드: {{ virustotal.timestamps.first_submission or '알 수 없음' }}</span>
                {% else %}
                <span class="vt-date-info">VirusTotal 데이터 없음</span>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>

  {% else %}
  <div class="card">
    <h2>분석 결과</h2>
    <div class="meta">분석 결과를 사용할 수 없습니다.</div>
  </div>
  {% endif %}

  <script>

    function toggleVtDetails() {
      const container = document.getElementById('vtVendorContainer');
      const btn = document.querySelector('.vt-toggle-btn');
      
      if (container.style.display === 'none') {
        container.style.display = 'block';
        btn.textContent = '접기';
      } else {
        container.style.display = 'none';
        btn.textContent = '상세보기';
      }
    }

    function toggleVtVendorDetails() {
      const container = document.getElementById('vtVendorContent');
      const btn = document.querySelector('.vt-vendor-toggle');
      
      if (container.style.display === 'none') {
        container.style.display = 'block';
        btn.textContent = '접기';
      } else {
        container.style.display = 'none';
        btn.textContent = '상세보기';
      }
    }

    function showMoreVendors() {
      const cleanList = document.getElementById('cleanVendorList');
      const showMoreBtn = document.querySelector('.vt-show-more');
      
      if (cleanList.classList.contains('collapsed')) {
        cleanList.classList.remove('collapsed');
        showMoreBtn.textContent = '접기';
      } else {
        cleanList.classList.add('collapsed');
        const hiddenCount = cleanList.querySelectorAll('.vt-vendor-item:nth-child(n+6)').length;
        showMoreBtn.textContent = `+ ${hiddenCount}개 더 보기`;
      }
    }

    // 안전 항목 토글
    function toggleSafeItems() {
      const safeItems = document.getElementById('safe-items');
      const toggleBtn = document.querySelector('.toggle-btn');
      
      if (safeItems && toggleBtn) {
        if (safeItems.classList.contains('hidden')) {
          safeItems.classList.remove('hidden');
          toggleBtn.textContent = '접기 ▲';
        } else {
          safeItems.classList.add('hidden');
          toggleBtn.textContent = '펼쳐보기 ▼';
        }
      }
    }
    
    // 상세 정보 토글
    function toggleDetails() {
      const detailsContent = document.getElementById('detailsContent');
      const toggleBtn = document.querySelector('.details-toggle');
      
      if (detailsContent && toggleBtn) {
        if (detailsContent.style.display === 'none') {
          detailsContent.style.display = 'block';
          toggleBtn.querySelector('.toggle-text').textContent = '접기';
          toggleBtn.querySelector('.toggle-icon').textContent = '▲';
        } else {
          detailsContent.style.display = 'none';
          toggleBtn.querySelector('.toggle-text').textContent = '더 자세히 보기';
          toggleBtn.querySelector('.toggle-icon').textContent = '▼';
        }
      }
    }
    
    // 전체 통계 토글
    function toggleAllStats() {
      const additionalStats = document.getElementById('additional-stats');
      const toggleBtn = document.querySelector('.show-all-btn');
      
      if (additionalStats && toggleBtn) {
        if (additionalStats.classList.contains('hidden')) {
          additionalStats.classList.remove('hidden');
          toggleBtn.textContent = '접기 ▲';
        } else {
          additionalStats.classList.add('hidden');
          toggleBtn.textContent = '전체 통계 보기 ▼';
        }
      }
    }
    
    // 섹션으로 스크롤 이동
    function scrollToSection(sectionId) {
      const element = document.getElementById(sectionId);
      if (element) {
        element.scrollIntoView({ 
          behavior: 'smooth', 
          block: 'start',
          inline: 'nearest'
        });
        
        // 잠깐 하이라이트 효과
        element.style.transition = 'background-color 0.3s ease';
        element.style.backgroundColor = '#f3f4f6';
        setTimeout(() => {
          element.style.backgroundColor = '';
        }, 1000);
      }
    }
    
    // 파일 삭제 함수
    function deleteFile() {
      if (confirm('이 파일을 삭제하시겠습니까?')) {
        // 실제 삭제 로직 구현
        alert('파일이 삭제되었습니다.');
        // 페이지 새로고침 또는 파일 목록 업데이트
        window.location.reload();
      }
    }
    
    // 상세보기 함수
    function viewDetails() {
      // 상세 정보 모달 또는 페이지로 이동
      alert('상세 정보를 보여주는 기능입니다.');
    }

    // 동적 원형 프로그레스 바 초기화 함수
    function initializeCircularProgress() {
      const progressElements = document.querySelectorAll('.circular-progress');
      
      progressElements.forEach(function(element) {
        // is-normal 클래스가 있으면 JavaScript 처리 건너뛰기
        if (element.classList.contains('is-normal')) {
          console.log('⏭️ Skipping Normal circle - using inline styles');
          return;
        }
        
        const percentage = parseFloat(element.getAttribute('data-percentage')) || 0;
        const fillElement = element.querySelector('.progress-ring-fill');
        
        if (fillElement) {
          // SVG 크기에 따라 원 둘레 계산
          const svgElement = element.querySelector('.progress-ring');
          const svgWidth = svgElement.getAttribute('width');
          const radius = svgWidth === '140' ? 60 : 50; // Malicious: 60, Normal: 50
          const circumference = 2 * Math.PI * radius;
          
          // 초기 상태 설정 (0%에서 시작)
          fillElement.style.strokeDasharray = circumference + ' ' + circumference;
          fillElement.style.strokeDashoffset = circumference;
          
          // 애니메이션 효과로 실제 퍼센트까지 진행
          setTimeout(function() {
            const offset = circumference - (percentage / 100) * circumference;
            fillElement.style.transition = 'stroke-dashoffset 1.5s cubic-bezier(0.4, 0, 0.2, 1)';
            fillElement.style.strokeDashoffset = offset;
          }, 200);
        }
      });
    }

    // 탭 전환 기능
    function initializeTabs() {
      const tabButtons = document.querySelectorAll('.tab-button');
      const tabContents = document.querySelectorAll('.tab-content');
      
      tabButtons.forEach(button => {
        button.addEventListener('click', function() {
          const targetTab = this.getAttribute('data-tab');
          
          // 모든 탭 버튼에서 active 클래스 제거
          tabButtons.forEach(btn => btn.classList.remove('active'));
          // 클릭된 탭 버튼에 active 클래스 추가
          this.classList.add('active');
          
          // 모든 탭 콘텐츠 숨기기
          tabContents.forEach(content => {
            content.classList.remove('active');
          });
          
          // 해당 탭 콘텐츠 보이기
          const targetContent = document.getElementById(targetTab + '-tab');
          if (targetContent) {
            targetContent.classList.add('active');
          }
        });
      });
    }

    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM 로드 완료');
      
      // 탭 기능 초기화
      initializeTabs();
      
      // 원형 그래프 애니메이션 초기화
      initializeCircularProgress();
      
      
      const style = document.createElement('style');
      style.textContent = `
        .vt-vendor-list.collapsed .vt-vendor-item:nth-child(n+6) {
          display: none;
        }
        
        /* 섹션 스타일 */
        .analysis-section {
          margin-top: 2rem;
          background: white;
          border-radius: 12px;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
          overflow: hidden;
        }
        
        .section-header {
          background: #f8f9fa;
          border-bottom: 1px solid #e9ecef;
          padding: 20px 24px;
        }
        
        .section-header h2 {
          margin: 0;
          font-size: 18px;
          font-weight: 600;
          color: #333;
        }
        
        .section-content {
          padding: 24px;
          min-height: 200px;
        }
        
        .no-data-message {
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          padding: 60px 20px;
          text-align: center;
          color: #6c757d;
        }
        
        .no-data-icon {
          font-size: 48px;
          margin-bottom: 16px;
          opacity: 0.5;
        }
        
        .no-data-text {
          font-size: 16px;
          font-weight: 500;
        }
        
        /* VirusTotal 새로운 디자인 스타일 */
        .vt-new-container {
          padding: 0;
        }
        
        /* 상단 위험도 알림 카드 */
        .vt-danger-alert {
          background: linear-gradient(135deg, #ff4757, #ff3742);
          color: white;
          border-radius: 12px;
          padding: 24px;
          margin-bottom: 24px;
          box-shadow: 0 8px 32px rgba(255, 71, 87, 0.3);
        }
        
        .vt-danger-alert.severity-safe {
          background: linear-gradient(135deg, #2ed573, #1e90ff);
        }
        
        .vt-danger-alert.severity-warning {
          background: linear-gradient(135deg, #ffa502, #ff6348);
        }
        
        .vt-danger-alert.severity-danger {
          background: linear-gradient(135deg, #ff4757, #ff3742);
        }
        
        .vt-alert-header {
          display: flex;
          align-items: center;
          margin-bottom: 16px;
        }
        
        .vt-alert-icon {
          font-size: 32px;
          margin-right: 16px;
        }
        
        .vt-alert-main {
          flex: 1;
        }
        
        .vt-alert-title {
          font-size: 28px;
          font-weight: 700;
          margin-bottom: 8px;
        }
        
        .vt-alert-subtitle {
          font-size: 16px;
          opacity: 0.9;
        }
        
        .vt-alert-percentage {
          font-size: 24px;
          font-weight: 700;
          background: rgba(255, 255, 255, 0.2);
          padding: 8px 16px;
          border-radius: 8px;
        }
        
        .vt-alert-description {
          font-size: 16px;
          margin-bottom: 16px;
          font-weight: 500;
        }
        
        .vt-alert-action {
          font-size: 14px;
          background: rgba(255, 255, 255, 0.15);
          padding: 12px;
          border-radius: 8px;
          border-left: 4px solid rgba(255, 255, 255, 0.5);
        }
        
        /* 중간 정보 카드들 */
        .vt-info-cards {
          display: grid;
          grid-template-columns: repeat(3, 1fr);
          gap: 20px;
          margin-bottom: 24px;
        }
        
        .vt-info-card {
          background: white;
          border: 1px solid #e1e8ed;
          border-radius: 12px;
          padding: 20px;
          text-align: center;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .vt-card-label {
          font-size: 14px;
          color: #657786;
          margin-bottom: 12px;
          font-weight: 500;
        }
        
        .vt-card-value {
          font-size: 32px;
          font-weight: 700;
          color: #1da1f2;
          margin-bottom: 8px;
        }
        
        .vt-card-value.vt-danger-value {
          color: #e0245e;
        }
        
        .vt-card-desc {
          font-size: 12px;
          color: #657786;
          line-height: 1.4;
        }
        
        /* 파일 특징 섹션 */
        .vt-file-features {
          background: white;
          border: 1px solid #e1e8ed;
          border-radius: 12px;
          padding: 20px;
          margin-bottom: 24px;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .vt-features-header {
          display: flex;
          align-items: center;
          margin-bottom: 16px;
        }
        
        .vt-features-icon {
          font-size: 20px;
          margin-right: 8px;
        }
        
        .vt-features-title {
          font-size: 18px;
          font-weight: 600;
          color: #14171a;
        }
        
        .vt-features-tags {
          display: flex;
          flex-wrap: wrap;
          gap: 8px;
        }
        
        .vt-feature-tag {
          background: #e3f2fd;
          color: #1976d2;
          padding: 6px 12px;
          border-radius: 16px;
          font-size: 14px;
          font-weight: 500;
        }
        
        /* 보안 회사별 검사 결과 섹션 */
        .vt-vendor-section {
          background: white;
          border: 1px solid #e1e8ed;
          border-radius: 12px;
          padding: 20px;
          margin-bottom: 24px;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .vt-vendor-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
        }
        
        .vt-vendor-icon {
          font-size: 20px;
          margin-right: 8px;
        }
        
        .vt-vendor-title {
          font-size: 18px;
          font-weight: 600;
          color: #14171a;
          flex: 1;
        }
        
        .vt-vendor-toggle {
          background: #9c27b0;
          color: white;
          border: none;
          padding: 8px 16px;
          border-radius: 6px;
          font-size: 14px;
          font-weight: 500;
          cursor: pointer;
          transition: background-color 0.2s ease;
        }
        
        .vt-vendor-toggle:hover {
          background: #7b1fa2;
        }
        
        .vt-vendor-content {
          margin-top: 20px;
          padding-top: 20px;
          border-top: 1px solid #e1e8ed;
        }
        
        .vt-no-vendor-data {
          text-align: center;
          color: #657786;
          font-style: italic;
          padding: 20px;
        }
        
        /* 도움말 섹션 */
        .vt-help-section {
          background: #f3e5f5;
          border-radius: 12px;
          padding: 24px;
          margin-bottom: 24px;
        }
        
        .vt-help-content {
          max-width: none;
        }
        
        .vt-help-text {
          margin-bottom: 16px;
          color: #4a148c;
          line-height: 1.6;
        }
        
        .vt-help-actions {
          display: flex;
          align-items: center;
          justify-content: space-between;
          flex-wrap: wrap;
          gap: 12px;
        }
        
        .vt-external-link {
          background: #9c27b0;
          color: white;
          text-decoration: none;
          padding: 10px 20px;
          border-radius: 6px;
          font-weight: 500;
          transition: background-color 0.2s ease;
        }
        
        .vt-external-link:hover {
          background: #7b1fa2;
        }
        
        .vt-upload-date {
          font-size: 12px;
          color: #666;
        }
        
        /* 반응형 디자인 */
        @media (max-width: 768px) {
          .section-header {
            padding: 16px 20px;
          }
          
          .section-content {
            padding: 16px 20px;
          }
          
          .vt-info-cards {
            grid-template-columns: 1fr;
            gap: 16px;
          }
          
          .vt-alert-header {
            flex-direction: column;
            text-align: center;
          }
          
          .vt-alert-icon {
            margin-right: 0;
            margin-bottom: 12px;
          }
          
          .vt-alert-title {
            font-size: 24px;
          }
          
          .vt-help-actions {
            flex-direction: column;
            align-items: stretch;
          }
          
          .vt-external-link {
            text-align: center;
          }
        }
      `;
      document.head.appendChild(style);
      
      // AI confidence bar 너비 설정
      const confidenceFills = document.querySelectorAll('.ai-confidence-fill[data-width]');
      confidenceFills.forEach(function(fill) {
        const width = fill.getAttribute('data-width');
        fill.style.width = width + '%';
      });
      
      // VirusTotal gauge fill 스타일 설정
      const gaugeFills = document.querySelectorAll('.gauge-fill[data-detection-rate]');
      gaugeFills.forEach(function(fill) {
        const detectionRate = parseFloat(fill.getAttribute('data-detection-rate'));
        fill.style.width = detectionRate + '%';
        
        // 위험도에 따른 배경색 설정
        if (detectionRate >= 60) {
          fill.style.background = 'linear-gradient(90deg, #FF6B6B, #D93025)';
        } else if (detectionRate >= 30) {
          fill.style.background = 'linear-gradient(90deg, #FF9F43, #F29900)';
        } else {
          fill.style.background = 'linear-gradient(90deg, #10B981, #059669)';
        }
      });
      
      // Gauge marker 위치 설정
      const gaugeMarkers = document.querySelectorAll('.gauge-marker[data-detection-rate]');
      gaugeMarkers.forEach(function(marker) {
        const detectionRate = parseFloat(marker.getAttribute('data-detection-rate'));
        marker.style.left = detectionRate + '%';
      });
      
      // AI 통계 바 너비 설정
      const statFills = document.querySelectorAll('.stat-fill[data-width]');
      statFills.forEach(function(fill) {
        const width = fill.getAttribute('data-width');
        fill.style.width = width + '%';
      });
    });

    // VirusTotal 상세보기 토글 함수
    function toggleVtDetails() {
      const container = document.getElementById('vtVendorContainer');
      const btn = document.querySelector('.vt-toggle-btn');
      
      if (container.style.display === 'none') {
        container.style.display = 'block';
        btn.textContent = '접기';
      } else {
        container.style.display = 'none';
        btn.textContent = '상세보기';
      }
    }


  </script>
</body>
</html>
