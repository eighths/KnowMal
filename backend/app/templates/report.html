<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>KnowMal - ë¬¸ì„œ ì•…ì„± ì½”ë“œ íƒì§€ ë¦¬í¬íŠ¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ›¡ï¸</text></svg>">
  <link rel="stylesheet" href="/static/css/report.css">
</head>
<body>
  {% if data.analysis_report or data.virustotal or data.ai_prediction %}
  
      <!-- í†µí•© íŒŒì¼ ì •ë³´ ì¹´ë“œ -->
      <div class="unified-file-card">
    <!-- ë¸Œëœë”© í—¤ë” -->
        <div class="card-header-section">
        <div class="service-branding">
            <div class="service-logo">
              <img src="/static/images/KnowMal_logo.png" alt="KnowMal" class="logo-image">
            </div>
            <div class="service-info">
                <h1 class="service-name">KnowMal</h1>
                <p class="service-tagline">ë¬¸ì„œ ì•…ì„± ì½”ë“œ íƒì§€ ì„œë¹„ìŠ¤</p>
            </div>
        </div>
        <div class="powered-by">
            <span>Powered by AI_Know</span>
          </div>
        </div>

        <!-- íŒŒì¼ ì •ë³´ ì¹´ë“œ -->
        <div class="file-card">
          <!-- ìƒë‹¨: íŒŒì¼ ì•„ì´ì½˜ + íŒŒì¼ëª… + ìœ„í—˜ ë°°ì§€ -->
          <div class="file-header">
            <div class="file-icon-section">
              <div class="file-icon">ğŸ“„</div>
            </div>
            <div class="file-title-section">
              <h2 class="file-name" title="{{ data.filename }}">{{ data.filename }}</h2>
              <div class="file-status-section">
      {% set virustotal = data.virustotal if data.virustotal else (data.analysis_report.virustotal if data.analysis_report else None) %}
      {% set ai_has_threat = false %}
      {% set ai_threats = [] %}
      {% if data.ai_prediction and data.ai_prediction.ai_analysis %}
        {% set predicted_types = data.ai_prediction.ai_analysis.predicted_types %}
        {% if predicted_types %}
          {% set dangerous_types = [] %}
          {% for threat in predicted_types %}
            {% if threat != 'Normal' %}
              {% set _ = dangerous_types.append(threat) %}
            {% endif %}
          {% endfor %}
          {% if dangerous_types %}
            {% set ai_has_threat = true %}
            {% set ai_threats = dangerous_types %}
          {% endif %}
        {% endif %}
      {% endif %}
      
      {% set vt_detection_rate = 0 %}
      {% set vt_malicious_count = 0 %}
      {% set vt_total_scans = 0 %}
      {% if virustotal and virustotal.available %}
        {% set scan_summary = virustotal.scan_summary %}
        {% set vt_detection_rate = (scan_summary.detection_rate or 0)|float %}
        {% set vt_malicious_count = scan_summary.malicious or 0 %}
        {% set vt_total_scans = scan_summary.total or 0 %}
      {% endif %}
      
                <!-- ìƒíƒœ ë°°ì§€ ê²°ì • -->
      {% if ai_has_threat and vt_detection_rate >= 30 %}
                  <span class="status-badge danger enhanced">
                    <span class="badge-icon">âš ï¸</span>
                    <span class="badge-text">ìœ„í—˜í•œ íŒŒì¼</span>
                  </span>
      {% elif ai_has_threat or vt_detection_rate >= 30 %}
                  <span class="status-badge warning enhanced">
                    <span class="badge-icon">âš ï¸</span>
                    <span class="badge-text">ì£¼ì˜ í•„ìš”</span>
                  </span>
      {% elif vt_detection_rate >= 10 %}
                  <span class="status-badge caution enhanced">
                    <span class="badge-icon">âš¡</span>
                    <span class="badge-text">ê²€í†  ê¶Œì¥</span>
                  </span>
      {% else %}
                  <span class="status-badge safe enhanced">
                    <span class="badge-icon">âœ“</span>
                    <span class="badge-text">ì•ˆì „í•œ íŒŒì¼</span>
                  </span>
      {% endif %}
              </div>
            </div>
          </div>
          
          <!-- ì¤‘ê°„: ì—…ë¡œë“œ ì •ë³´ -->
          <div class="file-upload-info">
            {% set mime_type = data.mime_type or "ì•Œ ìˆ˜ ì—†ìŒ" %}
            {% set friendly_type = "ì•Œ ìˆ˜ ì—†ìŒ" %}
            {% if mime_type.startswith('application/msword') or mime_type.startswith('application/vnd.openxmlformats-officedocument.wordprocessingml') %}
              {% set friendly_type = "Word ë¬¸ì„œ" %}
            {% elif mime_type.startswith('application/vnd.ms-excel') or mime_type.startswith('application/vnd.openxmlformats-officedocument.spreadsheetml') %}
              {% set friendly_type = "Excel ë¬¸ì„œ" %}
            {% elif mime_type.startswith('application/vnd.ms-powerpoint') or mime_type.startswith('application/vnd.openxmlformats-officedocument.presentationml') %}
              {% set friendly_type = "PowerPoint ë¬¸ì„œ" %}
            {% elif mime_type.startswith('application/pdf') %}
              {% set friendly_type = "PDF ë¬¸ì„œ" %}
            {% elif mime_type.startswith('text/') %}
              {% set friendly_type = "í…ìŠ¤íŠ¸ íŒŒì¼" %}
            {% elif mime_type.startswith('image/') %}
              {% set friendly_type = "ì´ë¯¸ì§€ íŒŒì¼" %}
            {% elif mime_type.startswith('video/') %}
              {% set friendly_type = "ë™ì˜ìƒ íŒŒì¼" %}
            {% elif mime_type.startswith('audio/') %}
              {% set friendly_type = "ì˜¤ë””ì˜¤ íŒŒì¼" %}
            {% elif mime_type.startswith('application/zip') or mime_type.startswith('application/x-rar') %}
              {% set friendly_type = "ì••ì¶• íŒŒì¼" %}
            {% elif mime_type.startswith('application/') %}
              {% set friendly_type = "ì‘ìš© í”„ë¡œê·¸ë¨" %}
            {% else %}
              {% set friendly_type = mime_type %}
            {% endif %}
            <span class="file-type">{{ friendly_type }}</span>
            <span class="file-separator">Â·</span>
            <span class="file-size">{{ (data.size_bytes / 1024)|round(1) }}KB</span>
          </div>
          
          <!-- í•˜ë‹¨: ì•¡ì…˜ ë²„íŠ¼ -->
          <div class="file-actions-bottom">
            <button class="action-btn delete-btn" onclick="deleteFile()">
              <span class="btn-icon">ğŸ—‘ï¸</span>
              <span class="btn-text">ì‚­ì œ</span>
            </button>
          </div>
        </div>
        </div>
      </div>

      <!-- ë¶„ì„ ê²°ê³¼ ì„¹ì…˜ -->
      <div class="analysis-section">
        <h3 class="section-title">ë¶„ì„ ê²°ê³¼</h3>

        <div class="analysis-grid">
          <!-- AI ë¶„ì„ ì¹´ë“œ -->
          <div class="analysis-card clickable-card" onclick="scrollToSection('ai-section')" data-target="ai-section">
            <div class="card-header">
              <span class="card-icon">ğŸ¤–</span>
              <span class="card-title">AI ë¶„ì„</span>
              <span class="card-arrow">â†’</span>
            </div>
            <div class="card-content">
              {% if ai_has_threat %}
                <div class="threat-summary">
                  <div class="threat-header">
                    <span class="threat-count-highlight">AIê°€ íƒì§€í•œ í•µì‹¬ ìœ„í˜‘: {{ ai_threats|length }}ê±´</span>
                  </div>
                  <div class="threat-list">
                    {% for threat in ai_threats[:3] %}
                    <div class="threat-item-enhanced">
                      <span class="threat-icon">
                        {% if threat == 'Backdoor' %}ğŸ”“
                        {% elif threat == 'Botnet' %}ğŸ¤–
                        {% elif threat == 'Download' %}ğŸ“¥
                        {% elif threat == 'Infiltration' %}ğŸ’€
                        {% else %}âš ï¸
                        {% endif %}
                      </span>
                      <span class="threat-tag-enhanced" 
                            title="{% if threat == 'Backdoor' %}ê³µê²©ìê°€ ì‚¬ìš©ìì˜ ì‹œìŠ¤í…œì— ëª°ë˜ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ë§Œë“¤ì–´ì§„ í†µë¡œì…ë‹ˆë‹¤.

ìœ„í—˜ë„: ë§¤ìš° ë†’ìŒ
ì˜í–¥: ì›ê²© ì œì–´, ë°ì´í„° íƒˆì·¨ ê°€ëŠ¥{% elif threat == 'Botnet' %}ì—¬ëŸ¬ ì»´í“¨í„°ë¥¼ ë„¤íŠ¸ì›Œí¬ë¡œ ì—°ê²°í•˜ì—¬ í•´ì»¤ê°€ ì›ê²©ìœ¼ë¡œ ì¡°ì¢…í•  ìˆ˜ ìˆëŠ” ë´‡ ë„¤íŠ¸ì›Œí¬ì…ë‹ˆë‹¤.

ìœ„í—˜ë„: ë§¤ìš° ë†’ìŒ
ì˜í–¥: DDoS ê³µê²©, ìŠ¤íŒ¸ ë°œì†¡, ì•”í˜¸í™”í ì±„êµ´{% elif threat == 'Download' %}ì¶”ê°€ì ì¸ ì•…ì„± íŒŒì¼ì„ ìë™ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œí•˜ì—¬ ì‹œìŠ¤í…œì— ë” ë§ì€ ìœ„í˜‘ì„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ìœ„í—˜ë„: ë†’ìŒ
ì˜í–¥: ì¶”ê°€ ì•…ì„±ì½”ë“œ ì„¤ì¹˜, ì‹œìŠ¤í…œ ì†ìƒ í™•ëŒ€{% elif threat == 'Infiltration' %}ì‹œìŠ¤í…œì— ì¹¨íˆ¬í•˜ì—¬ ë°ì´í„°ë¥¼ íƒˆì·¨í•˜ê±°ë‚˜ ì‹œìŠ¤í…œì„ ì†ìƒì‹œí‚¬ ìˆ˜ ìˆëŠ” ì•…ì„±ì½”ë“œì…ë‹ˆë‹¤.

ìœ„í—˜ë„: ë§¤ìš° ë†’ìŒ
ì˜í–¥: ë°ì´í„° ìœ ì¶œ, ì‹œìŠ¤í…œ íŒŒê´´, ê°œì¸ì •ë³´ ì¹¨í•´{% else %}ì•…ì„± í–‰ìœ„ë¥¼ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ” ìœ„í—˜í•œ í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤.

ìœ„í—˜ë„: ë†’ìŒ
ì˜í–¥: ì‹œìŠ¤í…œ ì†ìƒ, ë°ì´í„° ì†ì‹¤ ê°€ëŠ¥{% endif %}">{{ threat }}</span>
                    </div>
                    {% endfor %}
                  </div>
                </div>
              {% else %}
                <div class="safe-status">
                  <span class="safe-text">ì •ìƒ íŒŒì¼</span>
                </div>
              {% endif %}
            </div>
            </div>
            
          <!-- VirusTotal ì¹´ë“œ -->
          <div class="analysis-card clickable-card" onclick="scrollToSection('vt-section')" data-target="vt-section">
            <div class="card-header">
              <span class="card-icon">ğŸ”</span>
              <span class="card-title">VirusTotal ì¡°íšŒ ê²°ê³¼</span>
              <span class="card-arrow">â†’</span>
            </div>
            <div class="card-content">
              {% if virustotal and virustotal.available %}
                <div class="vt-summary">
                  <div class="vt-horizontal-gauge">
                    <div class="gauge-header">
                      <div class="gauge-percentage">{{ vt_detection_rate|round(1) }}%</div>
                      <div class="gauge-subtitle">({{ vt_malicious_count }}/{{ vt_total_scans }}ê°œ ì—”ì§„)</div>
                    </div>
                    <div class="gauge-container">
                      <div class="gauge-bar">
                        <div class="gauge-segments">
                          <div class="gauge-segment safe-segment"></div>
                          <div class="gauge-segment warning-segment"></div>
                          <div class="gauge-segment danger-segment"></div>
                        </div>
                        <div class="gauge-fill" 
                             data-percentage="{{ vt_detection_rate|round(1) }}"
                             style="width: {{ vt_detection_rate|round(1) }}%; background: {% if vt_detection_rate >= 60 %}linear-gradient(90deg, #FF6B6B, #D93025){% elif vt_detection_rate >= 30 %}linear-gradient(90deg, #FF9F43, #F29900){% else %}linear-gradient(90deg, #10B981, #059669){% endif %};"></div>
                        <div class="gauge-marker" style="left: {{ vt_detection_rate|round(1) }}%;"></div>
                      </div>
                      <div class="gauge-labels">
                        <span class="gauge-label safe">ì•ˆì „ (0-30%)</span>
                        <span class="gauge-label warning">ì£¼ì˜ (30-60%)</span>
                        <span class="gauge-label danger">ìœ„í—˜ (60-100%)</span>
                      </div>
                    </div>
                  </div>
                </div>
              {% else %}
                <div class="vt-unavailable">
                  <span class="vt-text">ê²€ì‚¬ ì •ë³´ ì—†ìŒ</span>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

            


        <!-- AI ì„¤ëª… ì„¹ì…˜ (Gemini API ì—°ë™ ì¤€ë¹„) -->
        <section class="ai-explanation-card">
          <div class="explanation-header">
            <span class="explanation-icon">ğŸ¤–</span>
            <h3 class="explanation-title">AIê°€ ë¶„ì„í•œ ìœ„í—˜ë„ ì„¤ëª…</h3>
            <span class="powered-badge">Powered by Gemini</span>
          </div>
          
          <div id="gemini-explanation" class="explanation-content">
            <!-- Gemini API ì‘ë‹µì´ ì—¬ê¸° ì‚½ì…ë¨ -->
            <div class="loading-skeleton">
              <div class="skeleton-line"></div>
              <div class="skeleton-line"></div>
              <div class="skeleton-line short"></div>
            </div>
          </div>
        </section>

        <!-- ë©”íƒ€ ì •ë³´ -->
        <div class="meta-info">
          {% if virustotal and virustotal.available %}
            {% if virustotal.timestamps.last_analysis %}
              <span class="meta-item">
                <span class="meta-icon">ğŸ“…</span>
                {{ virustotal.timestamps.last_analysis.split(' ')[0] }}
              </span>
            {% endif %}
            {% if virustotal.threat_info.suggested_label %}
              <span class="meta-divider">|</span>
              <span class="meta-item">
                <span class="meta-icon">ğŸ”—</span>
                {{ virustotal.threat_info.suggested_label }}
              </span>
            {% endif %}
          {% endif %}
        </div>
      </div>

  {% else %}
  <div class="card">
    <h2>ë¶„ì„ ê²°ê³¼</h2>
    <div class="meta">ë¶„ì„ ê²°ê³¼ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
  </div>
  {% endif %}

  <!-- ìƒì„¸ ë¶„ì„ ê²°ê³¼ (ë§¨ ì•„ë˜ë¡œ ì´ë™) -->
  <div class="card">
    <h2>ğŸ” ìƒì„¸ ë¶„ì„ ê²°ê³¼</h2>
    <div class="analysis-section">
      <h3>íŒŒì¼ êµ¬ì¡°</h3>
      {% set structure = data.analysis_report.features.structure if data.analysis_report and data.analysis_report.features else {} %}
      <div class="meta">
        Format: <strong>{{ structure.format or "unknown" }}</strong> &nbsp;â€¢&nbsp;
        OLE Header Valid: {{ "âœ“" if structure.ole_header_valid else "âœ—" }} &nbsp;â€¢&nbsp;
        Streams: {{ structure.streams_count or 0 }} &nbsp;â€¢&nbsp;
        Storages: {{ structure.storages_count or 0 }}
      </div>
      {% if structure.metadata_anomalies %}
      <div class="anomalies">
        <strong>ì´ìƒ ì§•í›„:</strong>
        {% for anomaly in structure.metadata_anomalies %}
          <span class="badge warning">{{ anomaly }}</span>
        {% endfor %}
      </div>
      {% endif %}
    </div>

    {% set macros = data.analysis_report.features.macros if data.analysis_report and data.analysis_report.features else {} %}
    {% if macros.has_vba %}
    <div class="analysis-section">
      <h3>ë§¤í¬ë¡œ ë¶„ì„</h3>
      <div class="meta">
        VBA ë§¤í¬ë¡œ: <strong class="danger">ë°œê²¬ë¨</strong> &nbsp;â€¢&nbsp;
        ëª¨ë“ˆ ìˆ˜: {{ macros.modules|length or 0 }} &nbsp;â€¢&nbsp;
        ì˜ì‹¬ìŠ¤ëŸ¬ìš´ API í˜¸ì¶œ: {{ macros.suspicious_api_calls_count or 0 }}
      </div>
      {% if macros.autoexec_triggers %}
      <div class="autoexec">
        <strong>ìë™ ì‹¤í–‰ íŠ¸ë¦¬ê±°:</strong>
        {% for trigger in macros.autoexec_triggers %}
          <span class="badge danger">{{ trigger }}</span>
        {% endfor %}
      </div>
      {% endif %}
      {% if macros.modules %}
      <div class="modules">
        <strong>VBA ëª¨ë“ˆ:</strong>
        {% for module in macros.modules %}
          <span class="module">{{ module.name }} ({{ module.line_count }}ì¤„{% if module.obfuscated %}, ë‚œë…í™”{% endif %})</span>
        {% endfor %}
      </div>
      {% endif %}
    </div>
    {% endif %}

    {% set strings = data.analysis_report.features.strings if data.analysis_report and data.analysis_report.features else {} %}
    {% if strings.urls %}
    <div class="analysis-section">
      <h3>ë„¤íŠ¸ì›Œí¬ ì§€í‘œ</h3>
      <div class="urls">
        <strong>ë°œê²¬ëœ URL:</strong>
        {% for url in strings.urls[:10] %}
          <div class="url-item"><code>{{ url }}</code></div>
        {% endfor %}
        {% if strings.urls|length > 10 %}
          <div class="more">... ë° {{ strings.urls|length - 10 }}ê°œ ë”</div>
        {% endif %}
      </div>
    </div>
    {% endif %}

    {% set security = data.analysis_report.features.security_indicators if data.analysis_report and data.analysis_report.features else {} %}
    {% if security %}
    <div class="analysis-section">
      <h3>ë³´ì•ˆ ì§€í‘œ</h3>
      <div class="meta">
        MOTW: {{ "âœ“" if security.motw_present else "âœ—" }} &nbsp;â€¢&nbsp;
        ë§¤í¬ë¡œ ë³´ì•ˆ: {{ security.macro_security_hint or "unknown" }}
        {% if security.digital_signature and security.digital_signature.signed %}
        &nbsp;â€¢&nbsp; ë””ì§€í„¸ ì„œëª…: <strong>ìˆìŒ</strong>
        {% if security.digital_signature.publisher %}
        ({{ security.digital_signature.publisher }})
        {% endif %}
        {% endif %}
      </div>
    </div>
    {% endif %}

    <!-- 2ë‹¨ ë ˆì´ì•„ì›ƒ ì»¨í…Œì´ë„ˆ -->
    <div class="two-column-layout">
      <!-- AI ì˜ˆì¸¡ ê²°ê³¼ (ì™¼ìª½) -->
      <div class="column-left">
    {% if data.ai_prediction and data.ai_prediction.ai_analysis %}
    {% set ai_analysis = data.ai_prediction.ai_analysis %}
    {% set predicted_types = ai_analysis.predicted_types %}
    {% set confidence_scores = ai_analysis.confidence_scores %}
    {% set model_classes = ai_analysis.model_classes %}
    
    <div class="analysis-section ai-section" id="ai-section">
          <h3>ğŸ¤– AI ë„¤íŠ¸ì›Œí¬ í–‰ìœ„ ì˜ˆì¸¡</h3>
      
      <div class="ai-prediction-card">
            <!-- ìœ„í—˜ í•­ëª© ê·¸ë£¹ -->
            {% if predicted_types %}
            <div class="prediction-group danger">
              <h3>âš ï¸ íƒì§€ëœ ìœ„í˜‘</h3>
              {% for class_name in predicted_types %}
              <div class="prediction-item danger">
                <div class="icon">ğŸš¨</div>
                <div class="content">
                  <div class="label">{{ class_name }}</div>
                  <div class="desc">
                    {% if class_name == 'Backdoor' %}ë°±ë„ì–´ - ì›ê²© ì ‘ê·¼ ì•…ì„±ì½”ë“œ
                    {% elif class_name == 'Botnet' %}ë´‡ë„· - ë„¤íŠ¸ì›Œí¬ ì œì–´ ì•…ì„±ì½”ë“œ
                    {% elif class_name == 'Download' %}ë‹¤ìš´ë¡œë” - ì¶”ê°€ ì•…ì„±ì½”ë“œ ë‹¤ìš´ë¡œë“œ
                    {% elif class_name == 'Infiltration' %}ì¹¨íˆ¬ - ì‹œìŠ¤í…œ ì¹¨ì… ì•…ì„±ì½”ë“œ
                    {% else %}{{ class_name }} - ì•…ì„±ì½”ë“œ ìœ í˜•
                    {% endif %}
                  </div>
                </div>
                <div class="status">íƒì§€ë¨</div>
              </div>
              {% endfor %}
              </div>
            {% endif %}
            
            <!-- ì•ˆì „ í•­ëª© ê·¸ë£¹ -->
            {% set safe_types = ['Infiltration', 'Normal'] %}
            {% set detected_safe = [] %}
            {% for class_name in safe_types %}
              {% if class_name not in predicted_types %}
                {% set _ = detected_safe.append(class_name) %}
              {% endif %}
            {% endfor %}
            
            {% if detected_safe %}
            <div class="prediction-group safe collapsed">
              <h3>âœ… ì •ìƒ í•­ëª© ({{ detected_safe|length }}ê°œ)</h3>
              <button class="toggle-btn" onclick="toggleSafeItems()">í¼ì³ë³´ê¸° â–¼</button>
              <div class="prediction-list hidden" id="safe-items">
                {% for class_name in detected_safe %}
                <div class="prediction-item safe">
                  <div class="icon">âœ…</div>
                  <div class="content">
                    <div class="label">{{ class_name }}</div>
                    <div class="desc">ì •ìƒ ìƒíƒœ</div>
          </div>
                  <div class="status">ì •ìƒ</div>
        </div>
                {% endfor %}
              </div>
            </div>
            {% endif %}
            
            <div class="divider"></div>
        
        
        {% if ai_analysis.network_feature_probabilities %}
        <div class="ai-network-section">
          <h3>ğŸ“Š ë„¤íŠ¸ì›Œí¬ í™œë™ ë¶„ì„</h3>
          <div class="network-stats">
            {% set feature_names = {
              'external_session_count': 'ì™¸ë¶€ ì—°ê²° ì‹œë„',
              'http_any_external_file_download': 'íŒŒì¼ ë‹¤ìš´ë¡œë“œ',
              'http_any_request': 'HTTP ìš”ì²­',
              'dns_any_request': 'DNS ì¡°íšŒ',
              'http_hosts_count': 'í˜¸ìŠ¤íŠ¸ ì—°ê²°',
              'dns_domains_count': 'ë„ë©”ì¸ ì¡°íšŒ',
              'http_user_agents_count': 'ì‚¬ìš©ì ì—ì´ì „íŠ¸',
              'http_redirect_chain_count': 'ë¦¬ë‹¤ì´ë ‰íŠ¸ ì²´ì¸',
              'http_download_mime_types_count': 'ë‹¤ìš´ë¡œë“œ íƒ€ì…',
              'http_methods_count': 'HTTP ë©”ì„œë“œ',
              'protocols_count': 'í”„ë¡œí† ì½œ ì‚¬ìš©'
            } %}
            
            {% set feature_icons = {
              'external_session_count': 'ğŸŒ',
              'http_any_external_file_download': 'ğŸ“¥',
              'http_any_request': 'ğŸ”—',
              'dns_any_request': 'ğŸ”',
              'http_hosts_count': 'ğŸ ',
              'dns_domains_count': 'ğŸŒ',
              'http_user_agents_count': 'ğŸ‘¤',
              'http_redirect_chain_count': 'ğŸ”„',
              'http_download_mime_types_count': 'ğŸ“„',
              'http_methods_count': 'âš¡',
              'protocols_count': 'ğŸ”§'
            } %}
            
            {% set sorted_features = [] %}
            {% for feature, probability in ai_analysis.network_feature_probabilities.items() %}
            {% if probability > 0.1 %}  
                {% set _ = sorted_features.append((feature, probability)) %}
              {% endif %}
            {% endfor %}
            {% set sorted_features = sorted_features|sort(attribute=1, reverse=true) %}
            
            {% for feature, probability in sorted_features[:5] %}
            {% set prob_percent = (probability * 100)|round(1) if probability <= 1 else probability|round(1) %}
            {% if prob_percent > 100 %}
              {% set prob_percent = 100 %}
            {% endif %}
            {% set risk_level = 'high' if prob_percent > 60 else 'medium' if prob_percent > 30 else 'low' %}
            <div class="stat-item {{ risk_level }}">
              <div class="stat-header">
                <span class="stat-icon">{{ feature_icons.get(feature, 'ğŸ“Š') }}</span>
                <span class="stat-name">{{ feature_names.get(feature, feature) }}</span>
                <span class="stat-value">{{ prob_percent }}%</span>
              </div>
              <div class="stat-bar">
                <div class="stat-fill {{ risk_level }}" style="width: {{ prob_percent }}%"></div>
              </div>
              <div class="stat-desc">{{ feature }}</div>
            </div>
            {% endfor %}
            
            {% if sorted_features|length > 5 %}
            <button class="show-all-btn" onclick="toggleAllStats()">ì „ì²´ í†µê³„ ë³´ê¸° ({{ sorted_features|length }}ê°œ) â–¼</button>
            <div class="additional-stats hidden" id="additional-stats">
              {% for feature, probability in sorted_features[5:] %}
              {% set prob_percent = (probability * 100)|round(1) if probability <= 1 else probability|round(1) %}
              {% if prob_percent > 100 %}
                {% set prob_percent = 100 %}
              {% endif %}
              {% set risk_level = 'high' if prob_percent > 60 else 'medium' if prob_percent > 30 else 'low' %}
              <div class="stat-item {{ risk_level }}">
                <div class="stat-header">
                  <span class="stat-icon">{{ feature_icons.get(feature, 'ğŸ“Š') }}</span>
                  <span class="stat-name">{{ feature_names.get(feature, feature) }}</span>
                  <span class="stat-value">{{ prob_percent }}%</span>
                </div>
                <div class="stat-bar">
                  <div class="stat-fill {{ risk_level }}" style="width: {{ prob_percent }}%"></div>
                </div>
                <div class="stat-desc">{{ feature }}</div>
              </div>
              {% endfor %}
            </div>
            {% endif %}
          </div>
        </div>
        {% endif %}
        
        <div class="ai-footer">
          <div class="ai-disclaimer">
            ğŸ’¡ <strong>AI ë¶„ì„ ì•ˆë‚´:</strong> ì´ ê²°ê³¼ëŠ” ê¸°ê³„í•™ìŠµ ëª¨ë¸ì— ê¸°ë°˜í•œ ì˜ˆì¸¡ì…ë‹ˆë‹¤. 
            ì‹¤ì œ ì•…ì„±ì½”ë“œ ì—¬ë¶€ëŠ” ì „ë¬¸ ë³´ì•ˆ ë„êµ¬ë¥¼ í†µí•´ í™•ì¸í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.
          </div>
        </div>
      </div>
    </div>
    {% endif %}
      </div>

      <!-- VirusTotal ê²°ê³¼ (ì˜¤ë¥¸ìª½) -->
      <div class="column-right">
        {% set virustotal = data.virustotal if data.virustotal else (data.analysis_report.virustotal if data.analysis_report else None) %}
    {% if virustotal and virustotal.available %}
    {% set scan_summary = virustotal.scan_summary %}
    {% set detection_rate = (scan_summary.detection_rate or 0)|float %}
    {% set malicious_count = scan_summary.malicious or 0 %}
    {% set total_scans = scan_summary.total or 0 %}
    {% set severity_class = 'safe' %}
    {% set severity_label = 'ì•ˆì „í•¨' %}
    {% set severity_icon = 'ğŸ›¡ï¸' %}
    {% set severity_hint = 'ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” íŒŒì¼ì…ë‹ˆë‹¤' %}
    {% set action_hint = 'ì´ íŒŒì¼ì€ ëŒ€ë¶€ë¶„ì˜ ë³´ì•ˆ í”„ë¡œê·¸ë¨ì—ì„œ ì•ˆì „í•˜ë‹¤ê³  íŒì •í–ˆìŠµë‹ˆë‹¤. ì•ˆì‹¬í•˜ê³  ì‚¬ìš©í•˜ì„¸ìš”.' %}
    {% if detection_rate >= 50 or malicious_count >= 10 %}
      {% set severity_class = 'critical' %}
      {% set severity_label = 'ë§¤ìš° ìœ„í—˜' %}
      {% set severity_icon = 'ğŸš¨' %}
      {% set severity_hint = 'ì•…ì„± íŒŒì¼ì¼ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤' %}
      {% set action_hint = 'ì¦‰ì‹œ íŒŒì¼ì„ ì‚­ì œí•˜ê³  ì‹œìŠ¤í…œì„ ì ê²€í•˜ì„¸ìš”. ì´ íŒŒì¼ì„ ì‹¤í–‰í•˜ì§€ ë§ˆì„¸ìš”.' %}
    {% elif detection_rate >= 20 or malicious_count >= 5 %}
      {% set severity_class = 'danger' %}
      {% set severity_label = 'ìœ„í—˜' %}
      {% set severity_icon = 'âš ï¸' %}
      {% set severity_hint = 'ì•…ì„± íŒŒì¼ì¼ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤' %}
      {% set action_hint = 'ì´ íŒŒì¼ì„ ì—´ì§€ ë§ˆì„¸ìš”. ê²©ë¦¬í•˜ê±°ë‚˜ ì‚­ì œë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.' %}
    {% elif detection_rate > 0 %}
      {% set severity_class = 'warning' %}
      {% set severity_label = 'ì£¼ì˜ í•„ìš”' %}
      {% set severity_icon = 'âš¡' %}
      {% set severity_hint = 'ì¼ë¶€ ì˜ì‹¬ìŠ¤ëŸ¬ìš´ íŠ¹ì§•ì´ ë°œê²¬ë¨' %}
      {% set action_hint = 'ì‹ ì¤‘í•˜ê²Œ ê²€í†  í›„ ì‚¬ìš©í•˜ì„¸ìš”. ê°€ëŠ¥í•˜ë©´ ë‹¤ë¥¸ ì¶œì²˜ì—ì„œ ë™ì¼í•œ íŒŒì¼ì„ í™•ì¸í•´ë³´ì„¸ìš”.' %}
    {% endif %}
    
    <div class="analysis-section vt-section" id="vt-section">
      <h3>ğŸ” VirusTotal ë°”ì´ëŸ¬ìŠ¤ ê²€ì‚¬ ê²°ê³¼</h3>
      
      <!-- ìœ„í—˜ë„ ìš”ì•½ ì¹´ë“œ -->
      <div class="vt-risk-card severity-{{ severity_class }}">
        <div class="vt-risk-header">
          <div class="vt-risk-icon">{{ severity_icon }}</div>
          <div class="vt-risk-main">
            <div class="vt-risk-label">{{ severity_label }}</div>
            <div class="vt-risk-score">{{ malicious_count }}/{{ total_scans }} ê°œ í”„ë¡œê·¸ë¨ì´ ìœ„í—˜í•˜ë‹¤ê³  íŒì •</div>
          </div>
          <div class="vt-risk-percentage">{{ detection_rate|round(1) }}%</div>
        </div>
        <div class="vt-risk-hint">{{ severity_hint }}</div>
        <div class="vt-action-guide">
          <strong>ê¶Œì¥ ì¡°ì¹˜:</strong> {{ action_hint }}
        </div>
      </div>

      <!-- ê²€ì‚¬ ì •ë³´ -->
      <div class="vt-info-grid">
        <div class="vt-info-item">
          <div class="vt-info-label">ê²€ì‚¬ ì—”ì§„ ìˆ˜</div>
          <div class="vt-info-value">{{ total_scans }}ê°œ</div>
          <div class="vt-info-desc">ì „ ì„¸ê³„ ë³´ì•ˆ íšŒì‚¬ë“¤ì˜ ë°”ì´ëŸ¬ìŠ¤ ê²€ì‚¬ í”„ë¡œê·¸ë¨</div>
        </div>
        <div class="vt-info-item">
          <div class="vt-info-label">ìœ„í—˜ íƒì§€</div>
          <div class="vt-info-value severity-{{ severity_class }}">{{ malicious_count }}ê°œ</div>
          <div class="vt-info-desc">ì•…ì„±ì½”ë“œë¼ê³  íŒì •í•œ í”„ë¡œê·¸ë¨ ìˆ˜</div>
        </div>
        {% if virustotal.threat_info.suggested_label %}
        <div class="vt-info-item">
          <div class="vt-info-label">ìœ„í˜‘ ìœ í˜•</div>
          <div class="vt-info-value">{{ virustotal.threat_info.suggested_label }}</div>
          <div class="vt-info-desc">ë°œê²¬ëœ ì•…ì„±ì½”ë“œì˜ ì¢…ë¥˜</div>
        </div>
        {% endif %}
        {% if virustotal.timestamps.last_analysis %}
        <div class="vt-info-item">
          <div class="vt-info-label">ê²€ì‚¬ ì¼ì‹œ</div>
          <div class="vt-info-value">{{ virustotal.timestamps.last_analysis.split(' ')[0] }}</div>
          <div class="vt-info-desc">ê°€ì¥ ìµœê·¼ì— ê²€ì‚¬í•œ ë‚ ì§œ</div>
        </div>
        {% endif %}
      </div>

      <!-- íƒœê·¸ ì •ë³´ -->
      {% if virustotal.threat_info.tags %}
      <div class="vt-tags-section">
        <div class="vt-tags-label">ğŸ·ï¸ íŒŒì¼ íŠ¹ì§•</div>
        <div class="vt-tags">
          {% for tag in virustotal.threat_info.tags %}
          <span class="vt-tag">{{ tag }}</span>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- ìƒì„¸ ê²€ì‚¬ ê²°ê³¼ -->
      {% if virustotal.vendor_results %}
      <div class="vt-details-section">
        <div class="vt-details-header">
          <span>ğŸ“‹ ì£¼ìš” ë³´ì•ˆ íšŒì‚¬ë³„ ê²€ì‚¬ ê²°ê³¼</span>
          <button class="vt-toggle-btn" onclick="toggleVtDetails()">ìƒì„¸ë³´ê¸°</button>
        </div>
        <div class="vt-vendor-container" id="vtVendorContainer" style="display: none;">
          <div class="vt-vendor-summary">
            {% set detected_vendors = [] %}
            {% set clean_vendors = [] %}
            {% for vendor, result in virustotal.vendor_results.items() %}
              {% if result.detected %}
                {% set _ = detected_vendors.append(vendor) %}
              {% else %}
                {% set _ = clean_vendors.append(vendor) %}
              {% endif %}
            {% endfor %}
            
            {% if detected_vendors %}
            <div class="vt-vendor-group danger">
              <div class="vt-vendor-group-title">âš ï¸ ìœ„í—˜í•˜ë‹¤ê³  íŒì •í•œ íšŒì‚¬ ({{ detected_vendors|length }}ê°œ)</div>
              <div class="vt-vendor-list">
                {% for vendor in detected_vendors %}
                <div class="vt-vendor-item danger">
                  <div class="vt-vendor-name">{{ vendor }}</div>
                  <div class="vt-vendor-result">{{ virustotal.vendor_results[vendor].result or virustotal.vendor_results[vendor].category }}</div>
                </div>
                {% endfor %}
              </div>
            </div>
            {% endif %}
            
            {% if clean_vendors %}
            <div class="vt-vendor-group safe">
              <div class="vt-vendor-group-title">âœ… ì•ˆì „í•˜ë‹¤ê³  íŒì •í•œ íšŒì‚¬ ({{ clean_vendors|length }}ê°œ)</div>
              <div class="vt-vendor-list collapsed" id="cleanVendorList">
                {% for vendor in clean_vendors[:5] %}
                <div class="vt-vendor-item safe">
                  <div class="vt-vendor-name">{{ vendor }}</div>
                  <div class="vt-vendor-result">ì •ìƒ íŒŒì¼</div>
                </div>
                {% endfor %}
                {% if clean_vendors|length > 5 %}
                <div class="vt-show-more" onclick="showMoreVendors()">+ {{ clean_vendors|length - 5 }}ê°œ ë” ë³´ê¸°</div>
                {% endif %}
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
      {% endif %}

      <!-- ì¶”ê°€ ì •ë³´ ë° ë§í¬ -->
      <div class="vt-footer-new">
        <div class="vt-learn-more">
          <strong>ğŸ’¡ ë„ì›€ë§:</strong> VirusTotalì€ ì „ ì„¸ê³„ 70ì—¬ ê°œ ë³´ì•ˆ íšŒì‚¬ì˜ ë°”ì´ëŸ¬ìŠ¤ ê²€ì‚¬ ì—”ì§„ìœ¼ë¡œ íŒŒì¼ ì•ˆì „ì„±ì„ ê²€ì¦í•˜ëŠ” ë¬´ë£Œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.
        </div>
        <div class="vt-links">
          <a href="{{ virustotal.permalink }}" target="_blank" rel="noopener" class="vt-link-btn">
            ğŸ”— VirusTotalì—ì„œ ìì„¸íˆ ë³´ê¸°
          </a>
          {% if virustotal.timestamps.first_submission %}
          <span class="vt-date-info">ìµœì´ˆ ì—…ë¡œë“œ: {{ virustotal.timestamps.first_submission.split(' ')[0] }}</span>
          {% endif %}
        </div>
      </div>
    </div>
    {% elif virustotal and not virustotal.available %}
    <div class="analysis-section vt-section">
      <h3>ğŸ” VirusTotal ë°”ì´ëŸ¬ìŠ¤ ê²€ì‚¬ ê²°ê³¼</h3>
      <div class="vt-error-card">
        {% if virustotal.error == 'file_not_found' %}
        <div class="vt-error-icon">â“</div>
        <div class="vt-error-content">
          <div class="vt-error-title">ê²€ì‚¬ ì •ë³´ ì—†ìŒ</div>
          <div class="vt-error-desc">ì´ íŒŒì¼ì€ ì•„ì§ VirusTotalì— ì—…ë¡œë“œëœ ì ì´ ì—†ìŠµë‹ˆë‹¤.</div>
          <div class="vt-error-action">ì§ì ‘ VirusTotalì— íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ê²€ì‚¬ë¥¼ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        </div>
        {% elif virustotal.error == 'rate_limit' %}
        <div class="vt-error-icon">â³</div>
        <div class="vt-error-content">
          <div class="vt-error-title">ì¼ì‹œì  ì œí•œ</div>
          <div class="vt-error-desc">ë„ˆë¬´ ë§ì€ ìš”ì²­ìœ¼ë¡œ ì¸í•´ ì ì‹œ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
          <div class="vt-error-action">ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜ VirusTotal ì›¹ì‚¬ì´íŠ¸ë¥¼ ì§ì ‘ ì´ìš©í•´ì£¼ì„¸ìš”.</div>
        </div>
        {% else %}
        <div class="vt-error-icon">âŒ</div>
        <div class="vt-error-content">
          <div class="vt-error-title">ê²€ì‚¬ ì˜¤ë¥˜</div>
          <div class="vt-error-desc">VirusTotal ì„œë¹„ìŠ¤ ì—°ê²° ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>
          <div class="vt-error-action">ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}
      </div>
  </div>



  <script>
    function toggleVtDetails() {
      const container = document.getElementById('vtVendorContainer');
      const btn = document.querySelector('.vt-toggle-btn');
      
      if (container.style.display === 'none') {
        container.style.display = 'block';
        btn.textContent = 'ì ‘ê¸°';
      } else {
        container.style.display = 'none';
        btn.textContent = 'ìƒì„¸ë³´ê¸°';
      }
    }

    function showMoreVendors() {
      const cleanList = document.getElementById('cleanVendorList');
      const showMoreBtn = document.querySelector('.vt-show-more');
      
      if (cleanList.classList.contains('collapsed')) {
        cleanList.classList.remove('collapsed');
        showMoreBtn.textContent = 'ì ‘ê¸°';
      } else {
        cleanList.classList.add('collapsed');
        const hiddenCount = cleanList.querySelectorAll('.vt-vendor-item:nth-child(n+6)').length;
        showMoreBtn.textContent = `+ ${hiddenCount}ê°œ ë” ë³´ê¸°`;
      }
    }

    // ì•ˆì „ í•­ëª© í† ê¸€
    function toggleSafeItems() {
      const safeItems = document.getElementById('safe-items');
      const toggleBtn = document.querySelector('.toggle-btn');
      
      if (safeItems && toggleBtn) {
        if (safeItems.classList.contains('hidden')) {
          safeItems.classList.remove('hidden');
          toggleBtn.textContent = 'ì ‘ê¸° â–²';
        } else {
          safeItems.classList.add('hidden');
          toggleBtn.textContent = 'í¼ì³ë³´ê¸° â–¼';
        }
      }
    }
    
    // ìƒì„¸ ì •ë³´ í† ê¸€
    function toggleDetails() {
      const detailsContent = document.getElementById('detailsContent');
      const toggleBtn = document.querySelector('.details-toggle');
      
      if (detailsContent && toggleBtn) {
        if (detailsContent.style.display === 'none') {
          detailsContent.style.display = 'block';
          toggleBtn.querySelector('.toggle-text').textContent = 'ì ‘ê¸°';
          toggleBtn.querySelector('.toggle-icon').textContent = 'â–²';
        } else {
          detailsContent.style.display = 'none';
          toggleBtn.querySelector('.toggle-text').textContent = 'ë” ìì„¸íˆ ë³´ê¸°';
          toggleBtn.querySelector('.toggle-icon').textContent = 'â–¼';
        }
      }
    }
    
    // ì „ì²´ í†µê³„ í† ê¸€
    function toggleAllStats() {
      const additionalStats = document.getElementById('additional-stats');
      const toggleBtn = document.querySelector('.show-all-btn');
      
      if (additionalStats && toggleBtn) {
        if (additionalStats.classList.contains('hidden')) {
          additionalStats.classList.remove('hidden');
          toggleBtn.textContent = 'ì ‘ê¸° â–²';
        } else {
          additionalStats.classList.add('hidden');
          toggleBtn.textContent = 'ì „ì²´ í†µê³„ ë³´ê¸° â–¼';
        }
      }
    }
    
    // ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤ ì´ë™
    function scrollToSection(sectionId) {
      const element = document.getElementById(sectionId);
      if (element) {
        element.scrollIntoView({ 
          behavior: 'smooth', 
          block: 'start',
          inline: 'nearest'
        });
        
        // ì ê¹ í•˜ì´ë¼ì´íŠ¸ íš¨ê³¼
        element.style.transition = 'background-color 0.3s ease';
        element.style.backgroundColor = '#f3f4f6';
        setTimeout(() => {
          element.style.backgroundColor = '';
        }, 1000);
      }
    }
    
    // íŒŒì¼ ì‚­ì œ í•¨ìˆ˜
    function deleteFile() {
      if (confirm('ì´ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        // ì‹¤ì œ ì‚­ì œ ë¡œì§ êµ¬í˜„
        alert('íŒŒì¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ë˜ëŠ” íŒŒì¼ ëª©ë¡ ì—…ë°ì´íŠ¸
        window.location.reload();
      }
    }
    
    // ìƒì„¸ë³´ê¸° í•¨ìˆ˜
    function viewDetails() {
      // ìƒì„¸ ì •ë³´ ëª¨ë‹¬ ë˜ëŠ” í˜ì´ì§€ë¡œ ì´ë™
      alert('ìƒì„¸ ì •ë³´ë¥¼ ë³´ì—¬ì£¼ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.');
    }

    document.addEventListener('DOMContentLoaded', function() {
      const style = document.createElement('style');
      style.textContent = `
        .vt-vendor-list.collapsed .vt-vendor-item:nth-child(n+6) {
          display: none;
        }
      `;
      document.head.appendChild(style);
      
      // AI confidence bar ë„ˆë¹„ ì„¤ì •
      const confidenceFills = document.querySelectorAll('.ai-confidence-fill[data-width]');
      confidenceFills.forEach(function(fill) {
        const width = fill.getAttribute('data-width');
        fill.style.width = width + '%';
      });
    });
  </script>
</body>
</html>
